<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <title>Cargando Anime... - Archinime</title>
  <meta name="description" content="Ver anime online en alta calidad en Archinime.">

<script>
  (function() {
    // PALETA "SYNTHWAVE": Solo colores fr√≠os y neones que combinan con la galaxia
    const colors = [
      "#00f3ff", // Cian Ne√≥n (Inicio)
      "#0066ff", // Azul El√©ctrico
      "#bc13fe", // Morado Protagonista
      "#ff0055", // Rosa Ne√≥n (Acento)
      "#bc13fe", // Morado (Regreso)
      "#0066ff", // Azul
      "#00f3ff"  // Cian (Final para loop perfecto)
    ];

    const animationDuration = 20000; // 6 segundos (igual que el CSS nuevo)
    const intervalTime = 20; 
    const segments = colors.length - 1;
    const step = (intervalTime / animationDuration) * segments;

    let currentProgress = 0;
    let metaTag = document.querySelector('meta[name="theme-color"]');
    
    if (!metaTag) {
      metaTag = document.createElement('meta');
      metaTag.name = "theme-color";
      document.head.appendChild(metaTag);
    }

    const hexToRgb = (hex) => {
      const bigint = parseInt(hex.slice(1), 16);
      return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
    };

    const rgbToHex = (r, g, b) => {
      return "#" + [r, g, b].map(x => {
        const hex = Math.round(x).toString(16);
        return hex.length === 1 ? "0" + hex : hex;
      }).join('');
    };

    const lerp = (start, end, t) => start + (end - start) * t;

    setInterval(() => {
      currentProgress += step;
      if (currentProgress >= segments) {
        currentProgress = currentProgress % segments;
      }

      const index = Math.floor(currentProgress);
      const t = currentProgress - index;
      const colorStart = hexToRgb(colors[index]);
      const colorEnd = hexToRgb(colors[index + 1]);

      const r = lerp(colorStart[0], colorEnd[0], t);
      const g = lerp(colorStart[1], colorEnd[1], t);
      const b = lerp(colorStart[2], colorEnd[2], t);

      metaTag.setAttribute('content', rgbToHex(r, g, b));
    }, intervalTime);
  })();
</script>
  
  <meta property="og:type" content="video.movie">
  <meta property="og:title" content="Archinime OS">
  <meta property="og:description" content="Disfruta del mejor anime online con interfaz Cyberpunk.">
  <meta property="og:image" content="Logo_Archinime.avif">
  <meta property="og:url" content="">
  <meta property="og:site_name" content="Archinime">

  <link rel="icon" href="Logo_Archinime.png" type="image/png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    /* ---------------------------
       ESTILOS GLOBALES
       --------------------------- */
    *{box-sizing:border-box;margin:0;padding:0}
   
    html, body {
      height: 100%;
      overflow-x: hidden;
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      background: transparent;
    }

    /* Fondo v√≠deo */
    #bg-video {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: -1;
      background: url('galaxia-morado1.avif') center/cover no-repeat,
                  linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.6));
      opacity: 1; 
      transition: opacity 0.8s ease;
      pointer-events: none;
    }
    
    /* Overlay */
    #overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: -5;
      background: rgba(0,0,0,0.6);
      pointer-events: none;
    }
    
    /* Pantalla de carga inicial */
    #loading-screen {
        position: fixed;
        top:0; left:0; width:100%; height:100%;
        background: #000; z-index: 9999;
        display:flex; justify-content:center; align-items:center;
        transition: opacity 0.5s;
    }

    /* --- CONTENEDOR PRINCIPAL --- */
    .container{
      position:relative;
      z-index:0;
      max-width:1000px;
      margin:80px auto; padding:20px;
      background: rgba(0, 0, 0, 0.85);
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
      animation:fadeIn 0.5s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateZ(0);
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    /* --- BOTONES SUPERIORES --- */
    /* CAMBIO 2: Fondo degradado para simular efecto en PC */
    .top-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        /* Efecto visual a√±adido para que parezca una barra superior */
        margin: -20px -20px 20px -20px;
        padding: 15px 20px;
        background: linear-gradient(to bottom, rgba(140, 82, 255, 0.3), transparent);
        border-radius: 12px 12px 0 0;
        border-bottom: 1px solid rgba(140, 82, 255, 0.2);
    }

    .back, .share-detail {
      display: inline-flex;
      align-items: center; justify-content: center;
      color:#0ff;text-decoration:none;font-weight:bold;font-size:0.9rem;
      transition:background .2s;cursor:pointer;
      background: rgba(0, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 20px;
    }
    .back:active, .share-detail:active { background: rgba(0, 255, 255, 0.3);
    }

    /* --- PORTADA --- */
    .anime-cover { text-align: center; margin-bottom: 25px;
    }
    .anime-cover img {
      max-height: 400px; width: auto; max-width: 100%;
      border-radius: 12px;
      object-fit: contain;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    h1{
      margin: 10px 0 15px;
      text-align: center;
      font-size: 1.8rem; color: #fff;
      text-shadow: 0 0 5px rgba(0, 255, 247, 0.5);
    }

    /* --- G√âNEROS --- */
    .genres-wrap {
      display: flex;
      flex-wrap: wrap; gap: 8px;
      justify-content: center; margin-bottom: 20px;
    }
    .genre-chip {
      padding: 6px 12px;
      font-size: 0.85rem; font-weight: 700;
      border-radius: 20px;
      border: 1px solid rgba(0, 255, 255, 0.4);
      background: rgba(0, 255, 255, 0.05);
      color: #e0ffff;
      cursor: default; 
      user-select: none;
    }
    .genre-chip:hover {
        background: rgba(0, 255, 255, 0.15);
    }

    /* --- DESCRIPCI√ìN --- */
    .desc{
      margin-bottom:20px; line-height:1.6;
      color:#ddd; font-size: 1rem;
      background:rgba(255,255,255,0.03); padding:15px;
      border-radius:8px;
      border-left:3px solid #0ff;
    }

    /* --- UPLOADER INFO (DISE√ëO MEJORADO) --- */
    .uploader-container {
        display: flex;
        align-items: center;
        justify-content: flex-end; /* Alineado a la derecha */
        margin-bottom: 30px;
        gap: 10px;
    }
    .upload-label {
        font-size: 0.85rem;
        color: #aaa;
    }
    .uploader-chip {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 5px 12px 5px 5px;
        /* Padding ajustado */
        border-radius: 50px;
        color: #fff;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    .uploader-chip:hover {
        background: rgba(0, 255, 255, 0.15);
        border-color: #0ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
    }
    .uploader-chip img {
        width: 32px; height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(0, 255, 255, 0.5);
    }
    .uploader-chip span {
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: 0.5px;
    }

    /* --- TEMPORADAS --- */
    details {
      margin-bottom:12px;
      background: #0d0214; /* Morado muy oscuro s√≥lido */
      border: 1px solid #4a004a;
      /* Borde morado */
      border-radius:8px;
      overflow:hidden;
    }
    details[open] { background: #0d0214;
    }
    
    summary {
      padding:15px; cursor:pointer; font-weight:bold; color:#0ff;
      display:flex;
      justify-content:space-between; align-items:center;
      list-style:none; user-select: none;
      touch-action: manipulation;
    }
    summary::-webkit-details-marker { display:none;
    }
    summary::after { content:'‚ñº'; font-size:1.5rem; }
    details[open] summary::after { content:'‚ñ≤';
    }

    .season-content { 
        padding: 10px; 
        display: block;
    }

    /* --- LISTA DE VIDEOS --- */
    .video-list { 
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(4, 1fr);
    }

    .ep-btn {
      display:flex; flex-direction: column;
      align-items: center; /* Cambiado a columna para el badge */
      justify-content: center;
      padding:10px 4px;
      background: #1a0525; /* Fondo s√≥lido */
      border: 1px solid #330c4d;
      border-radius:4px;
      text-decoration:none; color:#ddd;
      font-size:0.8rem; text-align:center;
      min-height: 55px; /* Aumentado un poco para el badge */
      transition: all 0.2s;
      position: relative;
    }
    .ep-btn:hover {
      background: #2a0a3d;
      border-color: #0ff;
      color: #0ff;
      box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
    }
    .ep-btn:active { background: #0ff;
      color: #000;
    }

    /* --- ESTILO PARA EPISODIOS VISTOS --- */
    .ep-btn.watched {
        background: #0f1d18;
        border-color: #00ff9d;
        color: #e0fff4;
        box-shadow: inset 0 0 5px rgba(0, 255, 157, 0.1);
    }
    .watched-tag {
        font-size: 0.65rem;
        color: #00ff9d;
        /* Verde ne√≥n */
        margin-top: 4px;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 3px;
        text-shadow: 0 0 5px rgba(0, 255, 157, 0.4);
    }
    /* ------------------------------------- */

    /* --- RECOMENDACIONES --- */
    .recommendations { margin-top:40px;
      padding-top:20px;
      border-top:1px solid #333;
    }
    .rec-title { margin-bottom:15px; color:#bbb; border-left:4px solid #ff4d4d; padding-left:10px;
    }
    
    /* 6 por fila en PC/Tablet */
    .rec-grid { 
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px; 
    }

    .rec-card { 
      background: #1a0525;
      border: 1.5px solid #330c4d;
      border-radius: 6px; 
      overflow: hidden;
      transition: all 0.2s;
    }

    .rec-card:hover {
      transform: translateY(-3px);
      background: #2a0a3d; 
      border-color: #0ff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
    }

    /* Para que el texto cambie a celeste al pasar el mouse sobre la tarjeta */
    .rec-card:hover p {
      color: #0ff;
    }
    .rec-card img { width:100%; aspect-ratio:2/3; object-fit:cover; display:block; }
    .rec-card p { padding:6px; font-size:0.8rem;
      text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#ccc; margin:0; }

    /* --- TOAST --- */
    .toast {
      position:fixed;
      bottom:50px; left:50%; transform:translateX(-50%);
      background:#0ff; color:#000; padding:8px 20px; border-radius:20px;
      display:none; z-index:999; font-weight:bold; box-shadow:0 0 10px rgba(0,0,0,0.5);
    }

    /* --- MEDIA QUERIES --- */
    @media (max-width: 1024px) {
        .video-list { grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 600px) {
        .container { 
            width:100%;
            margin-top:0; padding:15px; border-radius:0; border:none; background: rgba(0,0,0,0.6); 
        }
        .video-list { grid-template-columns: repeat(2, 1fr);
        gap: 6px; }
        h1 { font-size:1.4rem;
        }
        
        /* 3 por fila en M√ìVILES */
        .rec-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        .uploader-container {
            justify-content: flex-start;
            /* En movil alineado a la izquierda */
        }
    }
  </style>
</head>
<body>

  <div id="loading-screen"><h2 style="color:#0ff">Cargando...</h2></div>

  <div class="container">
    <div class="top-buttons">
        <a href="index.html" class="back">‚Üê Volver</a>
        <span id="share-detail" class="share-detail">üîó Compartir</span>
    </div>
    
    <div id="contenido"></div>

    <div class="recommendations">
        <div class="rec-title">Quiz√°s te guste:</div>
        <div class="rec-grid" id="rec-grid"></div>
    </div>
  
  </div>

  <div id="toast" class="toast">Enlace copiado</div>

  <video id="bg-video" autoplay muted loop playsinline poster="galaxia-morado1.avif">
    <source src="galaxia.mp4" type="video/mp4">
  </video>
  <div id="overlay"></div>

  <script>
    var version = new Date().getTime();
    document.write('<script src="index-data.js?v=' + version + '"><\/script>');
  </script>

  <script>
    var version = new Date().getTime();
    document.write('<script src="anime-detail-data.js?v=' + version + '"><\/script>');
  </script>

  <script>
    var version = new Date().getTime();
    document.write('<script src="musica-data.js?v=' + version + '"><\/script>');
  </script>

  <script>
    var version = new Date().getTime();
    document.write('<script src="users-data.js?v=' + version + '"><\/script>');
  </script>


  <script>
    /* ----------------------------------------------------
       1. Gesti√≥n de Carga
       ---------------------------------------------------- */
    window.addEventListener('load', () => {
        // --- PARCHE DE COMPATIBILIDAD ---
        if (typeof audioPlaylists === 'undefined' && typeof musica !== 'undefined') 
        {
            window.audioPlaylists = musica;
        }
        // ---------------------------------
        const screen = document.getElementById('loading-screen');
        screen.style.opacity = '0';
        setTimeout(() => { screen.style.display = 'none'; }, 500);
    });
    /* ----------------------------------------------------
       2. L√≥gica de Audio
       ---------------------------------------------------- */
    let currentAudio = null;
    let playlist = [];
    let currentTrackIndex = -1;

    function playTrack(index) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.onended = null;
        }

        const trackUrl = playlist[index];
        currentAudio = new Audio(trackUrl);
        currentAudio.volume = 0.4;
        currentAudio.loop = false;

        currentAudio.onended = () => {
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            playTrack(currentTrackIndex);
        };

        currentAudio.play().catch(e => console.log("Reproducci√≥n autom√°tica bloqueada o error:", e));
    }

    document.addEventListener('click', () => {
        // --- PARCHE DE COMPATIBILIDAD POR SI ACASO ---
        if (typeof audioPlaylists === 'undefined' && typeof musica !== 'undefined') {
            window.audioPlaylists = musica;
        }

        if (typeof audioPlaylists === 'undefined' || currentAudio) return;
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        
        if (audioPlaylists[id] && audioPlaylists[id].length > 0) {
            playlist = audioPlaylists[id];
            currentTrackIndex = Math.floor(Math.random() * playlist.length);
            playTrack(currentTrackIndex);
        }
    }, { once: true });
    /* ----------------------------------------------------
       3. Renderizado y L√≥gica Visual (CON MEJORA SEO)
       ---------------------------------------------------- */
    
    if (typeof data === 'undefined') {
        document.getElementById('contenido').innerHTML = "<h2 style='text-align:center; padding:50px; color:red;'>Error: No se pudo cargar el archivo de datos (anime-detail-data.js).</h2>";
    } else {
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        const anime = data[id];
        const container = document.getElementById('contenido');

        if (anime) {
            // ============================================
            // INICIO SEO DIN√ÅMICO MEJORADO
            // ============================================
            
            // 1. T√≠tulo de la pesta√±a
            document.title = `Ver ${anime.title} Online - Archinime OS`;

            // 2. Descripci√≥n para Google
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) {
                metaDesc.setAttribute('content', `Disfruta de ${anime.title} en HD. ${anime.desc.substring(0, 140)}... V√©alo gratis en Archinime.`);
            }

            // 3. Open Graph (Facebook, Discord, etc)
            const ogTitle = document.querySelector('meta[property="og:title"]');
            const ogDesc = document.querySelector('meta[property="og:description"]');
            const ogImage = document.querySelector('meta[property="og:image"]');
            const ogUrl = document.querySelector('meta[property="og:url"]');

            if (ogTitle) ogTitle.setAttribute('content', `Ver ${anime.title} - Archinime`);
            if (ogDesc) ogDesc.setAttribute('content', anime.desc.substring(0, 200) + "...");
            if (ogImage) ogImage.setAttribute('content', anime.cover);
            if (ogUrl) ogUrl.setAttribute('content', window.location.href);
            // ============================================
            // FIN SEO DIN√ÅMICO
            // ============================================

            // --- L√≥gica de G√©neros Actualizada ---
            let genreHtml = '';
            if (typeof animes !== 'undefined') {
                const animeInfo = animes.find(a => String(a.id) === String(id));
                if (animeInfo && animeInfo.genres && animeInfo.genres.length > 0) {
                    genreHtml = animeInfo.genres.map(g => 
                        `<span class="genre-chip">${escapeHtml(g)}</span>`
                    ).join('');
                } else {
                    genreHtml = '<span style="color:#aaa; font-size:0.8rem;">Sin g√©neros</span>';
                }
            }
            // -------------------------------------

            // --- NUEVO: L√ìGICA DE UPLOADER/SUBIDO POR ---
            let uploaderEmailOrName = anime.uploader || "Desconocido";
            let displayNick = uploaderEmailOrName; 
            let uploaderHtml = "";
            let userAvatar = "Logo_Archinime.avif";
            // Avatar por defecto

            if (typeof usersData !== 'undefined' && usersData[uploaderEmailOrName]) {
                const userData = usersData[uploaderEmailOrName];
                displayNick = userData.nick;
                userAvatar = userData.avatar || "Logo_Archinime.avif";

                // Estructura del bot√≥n moderno SIN EL ICONO DE LINK
                uploaderHtml = `
                    <div class="uploader-container">
                        <span class="upload-label">Subido por:</span>
                        <a href="${userData.social || '#'}" ${userData.social ? 'target="_blank"' : 'style="cursor:default"'} class="uploader-chip">
                            <img src="${userAvatar}" alt="${displayNick}">
                            <span>${displayNick}</span>
                        </a>
                    </div>
                `;
            } else {
                // Fallback si no est√° en la base de datos
                uploaderHtml = `
                    <div class="uploader-container">
                        <span class="upload-label">Subido por:</span>
                        <div class="uploader-chip" style="cursor:default">
                            <img src="${userAvatar}" alt="User">
                            <span>${displayNick}</span>
                        </div>
                    </div>
                `;
            }
            // ---------------------------------------------

            let html = `
                <div class="anime-cover"><img src="${anime.cover}" alt="cover"></div>
                <h1>${anime.title}</h1>
                <div class="genres-wrap" id="genres-container">${genreHtml}</div>
                <p class="desc">${anime.desc}</p>
                ${uploaderHtml}
            `;
            if(anime.seasons){
                anime.seasons.forEach((s, index) => {
                    html += `
                    <details ontoggle="toggleSeason(this, ${id}, ${index})">
                        <summary>${s.name || 'Temporada ' + s.num}</summary>
                         <div class="season-content">
                            ${s.cover ? `<img src="${s.cover}" loading="lazy" style="width:100%; border-radius:5px; margin-bottom:10px; display:block;">` : ''}
                            <div class="video-list" id="list-${index}"></div>
                            <div id="loading-${index}" style="display:none; text-align:center; padding:10px; color:#aaa;">Cargando...</div>
                        </div>
                    </details>`;
                });
            }
            container.innerHTML = html;
            renderRecommendations(id);
        } else {
            container.innerHTML = "<h2 style='text-align:center; padding:50px;'>Anime no encontrado o ID incorrecto.</h2>";
            document.title = "Anime No Encontrado - Archinime";
        }
    }

    /* ----------------------------------------------------
       4. Funciones Auxiliares
       ---------------------------------------------------- */
    function toggleSeason(details, animeId, seasonIndex) {
        if (!details.open) return;
        const listContainer = document.getElementById(`list-${seasonIndex}`);
        if (listContainer.children.length > 0) return; 

        const loadingMsg = document.getElementById(`loading-${seasonIndex}`);
        loadingMsg.style.display = 'block';

        const episodes = data[animeId].seasons[seasonIndex].eps;
        const total = episodes.length;
        const seasonNum = data[animeId].seasons[seasonIndex].num;
        
        let processed = 0;
        const CHUNK_SIZE = 40;
        function processChunk() {
            const fragment = document.createDocumentFragment();
            const limit = Math.min(processed + CHUNK_SIZE, total);

            for (let i = processed; i < limit; i++) {
                const ep = episodes[i];
                const a = document.createElement('a');
                a.href = `video-player.html?anime=${animeId}&s=${seasonNum}&e=${i+1}`;
                a.className = 'ep-btn';
                // --- L√ìGICA DE VISTO ---
                // Creamos una clave √∫nica: watched_ID_TEMP_EP
                const viewedKey = `watched_${animeId}_${seasonNum}_${i+1}`;
                if(localStorage.getItem(viewedKey)) {
                    a.classList.add('watched');
                    a.innerHTML = `
                        <span>‚ñ∂ ${ep.title}</span>
                        <div class="watched-tag"><i class="fas fa-check"></i> VISTO</div>
                    `;
                } else {
                    a.textContent = `‚ñ∂ ${ep.title}`;
                }
                // -----------------------

                fragment.appendChild(a);
            }

            listContainer.appendChild(fragment);
            processed += CHUNK_SIZE;
            if (processed < total) {
                requestAnimationFrame(processChunk);
            } else {
                loadingMsg.style.display = 'none';
            }
        }
        requestAnimationFrame(processChunk);
    }

    document.getElementById('share-detail').addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href);
        const t = document.getElementById('toast');
        t.style.display='block'; setTimeout(()=>t.style.display='none',2000);
    });
    function renderRecommendations(currentId) {
        const grid = document.getElementById('rec-grid');
        const keys = Object.keys(data).filter(k => k != currentId);
        const randomKeys = keys.sort(() => 0.5 - Math.random()).slice(0, 12);
        if(randomKeys.length === 0) {
             grid.innerHTML = '<p style="text-align:center; width:100%; color:#666;">No hay m√°s animes cargados.</p>';
             return;
        }

        grid.innerHTML = randomKeys.map(k => `
            <div class="rec-card" onclick="location.href='anime-detail.html?id=${k}'" style="cursor:pointer">
                <img src="${data[k].cover}" alt="${data[k].title}">
                <p>${data[k].title}</p>
            </div>
        `).join('');
    }

    function escapeHtml(str){
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>