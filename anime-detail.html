<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
  <title>Cargando Anime...</title>
  <meta name="description" content="Ver anime online en alta calidad.">
  <meta property="og:title" content="Archinime">
  <meta property="og:image" content="Logo_Archinime.avif">

  <link rel="icon" href="Logo_Archinime.png" type="image/png">

  <style>
    /* ---------------------------
       ESTILOS GLOBALES
       --------------------------- */
    *{box-sizing:border-box;margin:0;padding:0}
    
    html, body {
      height: 100%;
      overflow-x: hidden;
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      background: transparent;
    }

    /* Fondo v√≠deo */
    #bg-video {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: -1;
      background: url('galaxia-morado1.avif') center/cover no-repeat,
                  linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.6));
      opacity: 1; 
      transition: opacity 0.8s ease;
      pointer-events: none;
    }
    
    /* Overlay */
    #overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: -5;
      background: rgba(0,0,0,0.6);
      pointer-events: none;
    }
    
    /* Pantalla de carga inicial */
    #loading-screen {
        position: fixed;
        top:0; left:0; width:100%; height:100%;
        background: #000; z-index: 9999;
        display:flex; justify-content:center; align-items:center;
        transition: opacity 0.5s;
    }

    /* --- CONTENEDOR PRINCIPAL --- */
    .container{
      position:relative;
      z-index:0;
      max-width:1000px;
      margin:80px auto; padding:20px;
      background: rgba(0, 0, 0, 0.85);
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);
      animation:fadeIn 0.5s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateZ(0);
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    /* --- BOTONES SUPERIORES --- */
    .top-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .back, .share-detail {
      display: inline-flex;
      align-items: center; justify-content: center;
      color:#0ff;text-decoration:none;font-weight:bold;font-size:0.9rem;
      transition:background .2s;cursor:pointer;
      background: rgba(0, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 20px;
    }
    .back:active, .share-detail:active { background: rgba(0, 255, 255, 0.3);
    }

    /* --- PORTADA --- */
    .anime-cover { text-align: center; margin-bottom: 25px;
    }
    .anime-cover img {
      max-height: 400px; width: auto; max-width: 100%;
      border-radius: 12px;
      object-fit: contain;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    h1{
      margin: 10px 0 15px;
      text-align: center;
      font-size: 1.8rem; color: #fff;
      text-shadow: 0 0 5px rgba(0, 255, 247, 0.5);
    }

    /* --- G√âNEROS --- */
    .genres-wrap {
      display: flex;
      flex-wrap: wrap; gap: 8px;
      justify-content: center; margin-bottom: 20px;
    }
    .genre-chip {
      padding: 6px 12px;
      font-size: 0.85rem; font-weight: 700;
      border-radius: 20px;
      border: 1px solid rgba(0, 255, 255, 0.4);
      background: rgba(0, 255, 255, 0.05);
      color: #e0ffff;
      cursor: pointer;
    }

    .desc{
      margin-bottom:30px; line-height:1.6; color:#ddd; font-size: 1rem;
      background:rgba(255,255,255,0.03); padding:15px;
      border-radius:8px;
      border-left:3px solid #0ff;
    }

    /* --- TEMPORADAS --- */
details {
      margin-bottom:12px;
      background: #0d0214; /* Morado muy oscuro s√≥lido */
      border: 1px solid #4a004a; /* Borde morado */
      border-radius:8px;
      overflow:hidden;
    }
    details[open] { background: #0d0214;
    }
    
    summary {
      padding:15px; cursor:pointer; font-weight:bold; color:#0ff;
      display:flex;
      justify-content:space-between; align-items:center;
      list-style:none; user-select: none;
      touch-action: manipulation;
    }
    summary::-webkit-details-marker { display:none;
    }
    summary::after { content:'‚ñº'; font-size:1.5rem; }
    details[open] summary::after { content:'‚ñ≤';
    }

    .season-content { 
        padding: 10px; 
        display: block;
    }

    /* --- LISTA DE VIDEOS --- */
    .video-list { 
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(4, 1fr);
    }

.ep-btn {
      display:flex; align-items: center; justify-content: center;
      padding:10px 4px;
      background: #1a0525; /* Fondo s√≥lido */
      border: 1px solid #330c4d;
      border-radius:4px;
      text-decoration:none; color:#ddd;
      font-size:0.8rem; text-align:center;
      min-height: 45px;
      transition: all 0.2s;
    }
    .ep-btn:hover {
      background: #2a0a3d;
      border-color: #0ff;
      color: #0ff;
      box-shadow: 0 0 8px rgba(0, 255, 255, 0.3);
    }
    .ep-btn:active { background: #0ff; color: #000; }

    /* --- RECOMENDACIONES --- */
    .recommendations { margin-top:40px; padding-top:20px; border-top:1px solid #333;
    }
    .rec-title { margin-bottom:15px; color:#bbb; border-left:4px solid #ff4d4d; padding-left:10px;
    }
    
    /* 6 por fila en PC/Tablet */
    .rec-grid { 
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px; 
    }

.rec-card { 
  background: #1a0525; 
  border: 1.5px solid #330c4d;
  border-radius: 6px; 
  overflow: hidden;
  transition: all 0.2s; /* Cambiado a 'all' para que el color y fondo tambi√©n tengan transici√≥n */
}

.rec-card:hover {
  transform: translateY(-3px);
  background: #2a0a3d; /* Morado un poco m√°s claro */
  border-color: #0ff;   /* Borde celeste */
  box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
}

/* Para que el texto cambie a celeste al pasar el mouse sobre la tarjeta */
.rec-card:hover p {
  color: #0ff;
}
    .rec-card img { width:100%; aspect-ratio:2/3; object-fit:cover; display:block; }
    .rec-card p { padding:6px; font-size:0.8rem;
      text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#ccc; margin:0; }

    /* --- TOAST --- */
    .toast {
      position:fixed;
      bottom:50px; left:50%; transform:translateX(-50%);
      background:#0ff; color:#000; padding:8px 20px; border-radius:20px;
      display:none; z-index:999; font-weight:bold; box-shadow:0 0 10px rgba(0,0,0,0.5);
    }

    /* --- MEDIA QUERIES --- */
    @media (max-width: 1024px) {
        .video-list { grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 600px) {
        .container { 
            width:100%;
            margin-top:0; padding:15px; border-radius:0; border:none; background: rgba(0,0,0,0.6); 
        }
        .video-list { grid-template-columns: repeat(2, 1fr);
        gap: 6px; }
        h1 { font-size:1.4rem;
        }
        
        /* 3 por fila en M√ìVILES */
        .rec-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
    }
  </style>
</head>
<body>

  <div id="loading-screen"><h2 style="color:#0ff">Cargando...</h2></div>

  <div class="container">
    <div class="top-buttons">
        <a href="index.html" class="back">‚Üê Volver</a>
        <span id="share-detail" class="share-detail">üîó Compartir</span>
    </div>
    
    <div id="contenido"></div>

    <div class="recommendations">
        <div class="rec-title">Quiz√°s te guste:</div>
        <div class="rec-grid" id="rec-grid"></div>
    </div>
  </div>

  <div id="toast" class="toast">Enlace copiado</div>

  <video id="bg-video" autoplay muted loop playsinline poster="galaxia-morado1.avif">
    <source src="galaxia.mp4" type="video/mp4">
  </video>
  <div id="overlay"></div>

  <script src="anime-detail-data.js"></script>
  <script src="musica-data.js"></script>

  <script>
    /* ----------------------------------------------------
       1. Gesti√≥n de Carga
       ---------------------------------------------------- */
    window.addEventListener('load', () => {
        const screen = document.getElementById('loading-screen');
        screen.style.opacity = '0';
        setTimeout(() => { screen.style.display = 'none'; }, 500);
    });

    /* ----------------------------------------------------
       2. L√≥gica de Audio (MODIFICADA: Aleatorio inicio -> Ordenado)
       ---------------------------------------------------- */
    let currentAudio = null;
    let playlist = [];
    let currentTrackIndex = -1;

    // Funci√≥n para reproducir una pista seg√∫n su √≠ndice
    function playTrack(index) {
        // Detener audio anterior si existe
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.onended = null; // Limpiar evento anterior
        }

        // Obtener la canci√≥n actual
        const trackUrl = playlist[index];
        currentAudio = new Audio(trackUrl);
        currentAudio.volume = 0.4;
        currentAudio.loop = false; // Desactivamos loop infinito de una canci√≥n

        // Cuando la canci√≥n termine, pasar a la siguiente
        currentAudio.onended = () => {
            // Calcula el siguiente √≠ndice (vuelve a 0 si llega al final)
            currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
            playTrack(currentTrackIndex);
        };

        currentAudio.play().catch(e => console.log("Reproducci√≥n autom√°tica bloqueada o error:", e));
    }

    document.addEventListener('click', () => {
        // Verificamos si audioPlaylists existe y si ya estamos reproduciendo
        if (typeof audioPlaylists === 'undefined' || currentAudio) return;

        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        
        if (audioPlaylists[id] && audioPlaylists[id].length > 0) {
            playlist = audioPlaylists[id];
            
            // 1. Elegimos un √≠ndice aleatorio SOLO para empezar
            currentTrackIndex = Math.floor(Math.random() * playlist.length);
            
            // 2. Iniciamos la reproducci√≥n
            playTrack(currentTrackIndex);
        }
    }, { once: true });

    /* ----------------------------------------------------
       3. Renderizado y L√≥gica Visual
       ---------------------------------------------------- */
    
    // Verificamos que los datos existan
    if (typeof data === 'undefined') {
        document.getElementById('contenido').innerHTML = "<h2 style='text-align:center; padding:50px; color:red;'>Error: No se pudo cargar el archivo de datos (anime-detail-data.js).</h2>";
    } else {
        // Renderizado normal
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        const anime = data[id];
        const container = document.getElementById('contenido');

        if (anime) {
            document.title = `${anime.title} - Archinime`;
            let html = `
                <div class="anime-cover"><img src="${anime.cover}" alt="cover"></div>
                <h1>${anime.title}</h1>
                <div class="genres-wrap" id="genres-container"></div>
                <p class="desc">${anime.desc}</p>
            `;
            if(anime.seasons){
                anime.seasons.forEach((s, index) => {
                    html += `
                    <details ontoggle="toggleSeason(this, ${id}, ${index})">
                        <summary>${s.name || 'Temporada ' + s.num}</summary>
                        <div class="season-content">
                            ${s.cover ? `<img src="${s.cover}" loading="lazy" style="width:100%; border-radius:5px; margin-bottom:10px; display:block;">` : ''}
                            
                            <div class="video-list" id="list-${index}"></div>
                            <div id="loading-${index}" style="display:none; text-align:center; padding:10px; color:#aaa;">Cargando...</div>
                        </div>
                    </details>`;
                });
            }
            container.innerHTML = html;
            
            // Cargar G√©neros
            populateGenresForAnime(id);
            // Cargar Recomendaciones
            renderRecommendations(id);
        } else {
            container.innerHTML = "<h2 style='text-align:center; padding:50px;'>Anime no encontrado o ID incorrecto.</h2>";
        }
    }

    /* ----------------------------------------------------
       4. Funciones Auxiliares (Renderizado Chunking)
       ---------------------------------------------------- */
    function toggleSeason(details, animeId, seasonIndex) {
        if (!details.open) return;
        const listContainer = document.getElementById(`list-${seasonIndex}`);
        if (listContainer.children.length > 0) return; // Ya cargado

        const loadingMsg = document.getElementById(`loading-${seasonIndex}`);
        loadingMsg.style.display = 'block';

        const episodes = data[animeId].seasons[seasonIndex].eps;
        const total = episodes.length;
        const seasonNum = data[animeId].seasons[seasonIndex].num;
        
        let processed = 0;
        const CHUNK_SIZE = 40; // Procesa 40 cap√≠tulos por frame para evitar lag

        function processChunk() {
            const fragment = document.createDocumentFragment();
            const limit = Math.min(processed + CHUNK_SIZE, total);

            for (let i = processed; i < limit; i++) {
                const ep = episodes[i];
                const a = document.createElement('a');
                a.href = `video-player.html?anime=${animeId}&s=${seasonNum}&e=${i+1}`;
                a.className = 'ep-btn';
                a.textContent = `‚ñ∂ ${ep.title}`;
                fragment.appendChild(a);
            }

            listContainer.appendChild(fragment);
            processed += CHUNK_SIZE;
            if (processed < total) {
                requestAnimationFrame(processChunk);
            } else {
                loadingMsg.style.display = 'none';
            }
        }
        requestAnimationFrame(processChunk);
    }

    document.getElementById('share-detail').addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href);
        const t = document.getElementById('toast');
        t.style.display='block'; setTimeout(()=>t.style.display='none',2000);
    });

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = "‚úÖ " + msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    // L√≥gica de recomendaciones
    function renderRecommendations(currentId) {
        const grid = document.getElementById('rec-grid');
        const keys = Object.keys(data).filter(k => k != currentId);
        // Si hay pocos animes, muestra todos, si hay muchos, randomiza
        const randomKeys = keys.sort(() => 0.5 - Math.random()).slice(0, 12);
        if(randomKeys.length === 0) {
             grid.innerHTML = '<p style="text-align:center; width:100%; color:#666;">No hay m√°s animes cargados.</p>';
             return;
        }

        grid.innerHTML = randomKeys.map(k => `
            <div class="rec-card" onclick="location.href='anime-detail.html?id=${k}'" style="cursor:pointer">
                <img src="${data[k].cover}" alt="${data[k].title}">
                <p>${data[k].title}</p>
            </div>
        `).join('');
    }

    /* ------------------------------------------------------------------
       L√≥gica para copiar g√©neros desde index.txt / index.html
       ------------------------------------------------------------------ */
    function renderGenres(genres){
      const cont = document.getElementById('genres-container');
      if(!cont) return;
      if(!genres || !genres.length){ 
          cont.innerHTML = '<span style="font-size:0.8rem; color:#aaa;">G√©neros no disponibles</span>';
          return; 
      }
      
      cont.innerHTML = genres.map(g => `
        <button class="genre-chip" data-genre="${escapeHtml(g)}">
          ${escapeHtml(g)}
          <span class="copied-badge">‚úì</span>
        </button>
      `).join('');
      cont.querySelectorAll('.genre-chip').forEach(btn => {
        btn.addEventListener('click', async (ev) => {
          const genre = btn.dataset.genre;
          try { await navigator.clipboard.writeText(genre); } catch(e){}
          btn.classList.add('popped','show-badge');
          setTimeout(() => btn.classList.remove('popped'), 350);
          setTimeout(() => btn.classList.remove('show-badge'), 1200);
          showToast(`G√©nero copiado: ${genre}`);
        });
      });
    }

    function populateGenresForAnime(animeId){
      const tries = ['index.txt','index.html'];
      let tried = 0;

      function tryNext(){
        if(tried >= tries.length){ 
            renderGenres([]);
            return;
        }
        const url = tries[tried++];
        fetch(url)
          .then(r => r.text())
          .then(text => {
            // Busca la estructura de datos en el archivo index
            const m = text.match(/const\s+animes\s*=\s*(\[[\s\S]*?\])\s*;/m);
            if(!m){ 
                tryNext(); 
                return; 
            }
            try {
              const arrayLiteral = m[1];
              // Parseamos el array de animes del index
              const arr = (new Function('return ' + arrayLiteral))();
              const item = arr.find(it => Number(it.id) === Number(animeId) || String(it.id) === String(animeId));
              
              if(item && item.genres && item.genres.length){ 
                  renderGenres(item.genres); 
                  return; 
              }
              // Intento secundario por t√≠tulo si el ID no coincide
              if (data[animeId]) {
                  const currentTitle = normalizeText(data[animeId].title);
                  const matchByTitle = arr.find(it => it.title && normalizeText(it.title) === currentTitle);
                  if(matchByTitle && matchByTitle.genres && matchByTitle.genres.length){ 
                      renderGenres(matchByTitle.genres);
                      return;
                  }
              }
              renderGenres([]);
            } catch(e){
              console.warn('Error parseando g√©neros del index:', e);
              tryNext();
            }
        }).catch(()=>{ tryNext(); });
      }
      tryNext();
    }

    function normalizeText(s){
      return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    }
    function escapeHtml(str){
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>