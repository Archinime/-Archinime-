<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archinime OS | Next Gen Platform</title>
  
  <link rel="icon" href="Logo_Archinime.avif" type="image/png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#8c52ff">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <script>
    // Crea una versión única basada en la hora actual
    // Esto obliga al navegador a descargar el archivo nuevo SIEMPRE
    var autoVersion = new Date().getTime(); 
    document.write('<link rel="stylesheet" href="styles-index.css?v=' + autoVersion + '">');
  </script>
  <noscript><link rel="stylesheet" href="styles-index.css"></noscript>

  <style>
    /* Estilos críticos para el loader */
    :root { --neon-cyan: #00f3ff; --dark-bg: #050505; }
    #page-loader {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 99999;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        transition: opacity 0.5s ease-out, visibility 0.5s;
    }
    .loader-glitch {
        font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: white;
        text-shadow: 2px 2px 0px #ff0055, -2px -2px 0px #00f3ff;
        animation: glitch 0.8s infinite; letter-spacing: 4px;
    }
    @keyframes glitch {
        0% { text-shadow: 2px 2px 0px #ff0055, -2px -2px 0px #00f3ff; }
        50% { text-shadow: -2px -2px 0px #ff0055, 2px 2px 0px #00f3ff; }
        100% { text-shadow: 2px 2px 0px #ff0055, -2px -2px 0px #00f3ff; }
    }
  </style>
</head>
<body>

  <div id="page-loader">
    <div class="loader-glitch">Archinime</div>
    <div style="width: 220px; height: 3px; background: #222; margin-top: 15px; overflow: hidden; border-radius: 2px;">
      <div style="width: 100%; height: 100%; background: #00f3ff; animation: loadLine 1.5s forwards ease-in-out;"></div>
    </div>
  </div>

  <video id="bg-video" poster="galaxia-morado1.avif" autoplay muted loop playsinline preload="auto">
    <source src="galaxia.mp4" type="video/mp4">
  </video>
  <div id="overlay" aria-hidden="true"></div>
  <div id="scanlines"></div>
  <audio id="bg-music"></audio> 

  <nav class="cyber-nav">
    <a href="https://archinime.github.io/-Archinime-/Archinime%20CMS%20-%20Creador.html" target="_blank" class="nav-logo" title="Ir al Creador CMS">
      <img id="logo" src="Logo_Archinime.avif" alt="Logo Archinime">
      <span class="nav-logo-text">ARCHINIME</span>
    </a>

    <div class="search-wrapper">
      <input id="search" class="search-input" placeholder="Acceder a base de datos..." aria-label="Buscar anime">
      <i class="fas fa-search search-icon"></i>
    </div>

    <div class="nav-actions header-actions">
      <button id="installBtn" class="cyber-btn-icon install-pulse" title="Instalar App">
        <i class="fas fa-download"></i>
      </button>

      <div class="notif-wrapper">
        <button id="notifBtn" class="cyber-btn-icon" onclick="toggleNotifMenu()" title="Centro de Control">
          <i class="fas fa-bell"></i>
          <span id="notifBadge" class="notif-badge" style="display:none"></span>
        </button>
        <div id="notifMenu" class="notif-dropdown">
            <div class="notif-header"><i class="fas fa-network-wired"></i> TRANSMISIONES</div>
            <div id="notifList" class="notif-list">
                <div class="empty-notif" style="padding:20px; text-align:center; color:#666;">Buscando señal...</div>
            </div>
        </div>
      </div>
      
      <button class="cyber-btn-icon" onclick="window.open('https://www.youtube.com/@Archinime-k2g', '_blank')" title="YouTube">
        <img src="youtube.avif" alt="YT" style="width:20px; border-radius:50%; opacity:0.8;">
      </button>
    </div>
  </nav>

  <div class="controls-container controls" id="controls">
    <select id="genre-select" onchange="filtro()" aria-label="Seleccionar género">
        <option value="">Todos los géneros</option>
        <option>Acción</option><option>Aventura</option><option>Ciencia ficción</option>
        <option>Comedia</option><option>Cyberpunk</option><option>Drama</option>
        <option>Ecchi</option><option>Escolar</option><option>Fantasía</option>
        <option>Harem</option><option>Horror</option><option>Isekai</option>
        <option>Mecha</option><option>Misterio</option><option>Psicológico</option>
        <option>Romance</option><option>Seinen</option><option>Shōnen</option>
        <option>Slice of Life</option><option>Sobrenatural</option><option>Terror</option>
        <option>Yuri</option><option>Yaoi</option>
    </select>

    <select id="demographic-select" onchange="filtro()" aria-label="Seleccionar demografía">
        <option value="">Todas las demografías</option>
        <option>Josei</option><option>Kodomo</option><option>Seijin</option>
        <option>Seinen</option><option>Shōjo</option><option>Shōnen</option>
    </select>

    <select id="rating-select" onchange="filtro()" aria-label="Seleccionar valoración">
      <option value="">⭐ RANKING GLOBAL</option>
      <option value="excellent">S-TIER (4.8+)</option>
      <option value="good">A-TIER (4.6+)</option>
      <option value="regular">B-TIER (&lt;4.5)</option>
    </select>
  </div>

  <main class="container">
    <div class="grid" id="grid"></div>
  </main>

  <div class="stage" aria-hidden="true">
    <div id="fgContainer" aria-label="Vídeo frontal">
      <canvas id="fgCanvas"></canvas>
      <video id="fgVideo" muted loop playsinline></video>
    </div>
    <div class="play-overlay" id="playOverlay">
      <button class="play-btn" id="playBtn">▶ INICIAR ENLACE</button>
    </div>
  </div>

  <div id="decorations" aria-hidden="true" style="position:fixed; inset:0; pointer-events:none; z-index:1;"></div>

  <div id="iosInstallModal" class="ios-modal">
      <div class="ios-content">
          <span class="ios-close" onclick="closeIosModal()">&times;</span>
          <h3 style="color:white; margin-bottom:10px;">Instalar Sistema</h3>
          <p>Para añadir <strong>Archinime</strong> a iOS:</p>
          <p>1. Toca <strong>Compartir</strong> <i class="fas fa-share-square"></i></p>
          <p>2. Elige <strong>"Agregar a Inicio"</strong> <i class="far fa-plus-square"></i></p>
      </div>
  </div>

  <div id="eventModal">
      <div class="event-card">
          <div class="event-close" onclick="closeEventModal()"><i class="fas fa-times"></i></div>
          <div class="event-visuals">
             <div class="visual-bg" id="evBg"></div>
             <div class="covers-container">
                 <img src="" class="cover-back" id="evCoverBack">
                 <img src="" class="cover-front" id="evCoverFront">
             </div>
             <div class="event-type-badge" id="evBadge">ESTRENO</div>
             <div class="final-stamp">DISPONIBLE</div>
          </div>
          <div class="event-info">
             <div class="event-meta" id="evMeta">NUEVO EPISODIO</div>
             <h2 class="event-title" id="evTitle">Titulo Anime</h2>
             <p class="event-desc" id="evDesc">Descripción breve...</p>
             <button class="event-btn" id="evBtn">VER AHORA <i class="fas fa-play"></i></button>
          </div>
      </div>
  </div>

  <script>
    // Esta función usa la misma versión automática para los scripts
    function loadScript(src) {
      document.write('<script src="' + src + '?v=' + autoVersion + '"><\/script>');
    }
    
    // Carga tus scripts aquí
    loadScript('index-data.js');
    loadScript('animaciones.js');
    loadScript('musica_fondo.js');
    loadScript('notification-system.js');
    loadScript('script-index.js');
    // Si tienes el pwa-handler en archivo aparte:
    // loadScript('pwa-handler.js'); 
  </script>

  <script>
    /* REGISTRO SW AUTOMÁTICO */
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
            .then(reg => {
                console.log('SW Auto-Update activo');
                // Buscar actualizaciones cada vez que se carga la página
                reg.update(); 
            });
        });
    }

    /* PWA INSTALL HANDLER */
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    const iosModal = document.getElementById('iosInstallModal');
    
    const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
    const isMobile = () => window.matchMedia('(max-width: 780px)').matches;

    function checkInstallVisibility() {
        if (isMobile() && !isInStandaloneMode()) installBtn.style.display = 'flex';
        else installBtn.style.display = 'none';
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      checkInstallVisibility();
    });

    if(installBtn) {
        installBtn.addEventListener('click', () => {
            if (isIos()) iosModal.style.display = 'block';
            else if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => deferredPrompt = null);
            } else {
                alert("App ya instalada o no soportada.");
            }
        });
    }
    
    function closeIosModal() { iosModal.style.display = 'none'; }
    window.addEventListener('DOMContentLoaded', checkInstallVisibility);

    /* INICIO Y VIDEO */
    window.addEventListener('load', () => {
      const loader = document.getElementById('page-loader');
      const bgVideo = document.getElementById('bg-video');
      
      if(bgVideo) {
          bgVideo.muted = true;
          bgVideo.play().catch(() => {
              document.body.addEventListener('click', () => bgVideo.play(), {once:true});
          });
      }
      setTimeout(() => { 
        loader.style.opacity = '0'; 
        setTimeout(() => {
            loader.style.visibility = 'hidden';
            if (window.startNotificationSequence) window.startNotificationSequence();
        }, 500);
      }, 800);
    });
  </script>
</body>
</html>