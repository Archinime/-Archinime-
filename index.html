<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archinime</title>
  <link rel="icon" href="Logo_Archinime.png" type="image/png">
  <link rel="preload" as="video" href="fondonavidad.mp4" type="video/mp4">
  <link rel="preload" as="image" href="videoframe.jpg">

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;overflow-x:hidden; overflow-y:auto; font-family:sans-serif; color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}

    /* Fondo galaxia (poster + v√≠deo) */
    #bg-video{position:fixed; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-2; opacity:0; transition:opacity .6s ease; background:#000; pointer-events:none;}
    #overlay{position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; background: url('galaxia-poster.jpg') center/cover no-repeat, linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.6)); opacity:1; transition:opacity .6s ease; pointer-events:none;}

    header{ position:sticky; top:0; padding:1rem 2rem; display:flex; align-items:center; gap:1rem; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); z-index:40; transition:background .3s; flex-wrap:wrap; }

    /* t√≠tulo y logo */
    header h1{
      cursor:default; display:flex; align-items:center; gap:.6rem; font-size:1.8rem; font-weight:900;
      white-space:nowrap; flex:0 0 auto; animation: hueShift 8s linear infinite;
      /* texto con gradiente interno animado */
      background: linear-gradient(90deg,
        #00fff7 0%,
        #7afcff 12%,
        #9bff6a 24%,
        #ffd700 36%,
        #ff6ad5 48%,
        #ff4d4d 60%,
        #ff9f40 72%,
        #8b5cf6 84%,
        #00d4ff 100%);
      background-size: 250% 250%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      transition: transform .28s ease;
      /* Le damos un poco de 'brillo' interno con sombra muy sutil */
      text-shadow: 0 1px 18px rgba(0,0,0,0.5);
    }

    /* animated gradient movement */
    @keyframes hueShift {
      0% { background-position: 0% 50%; transform: translateY(0); }
      25% { background-position: 50% 100%; transform: translateY(-1px); }
      50% { background-position: 100% 50%; transform: translateY(0); }
      75% { background-position: 50% 0%; transform: translateY(1px); }
      100% { background-position: 0% 50%; transform: translateY(0); }
    }

    header h1 img#logo { width:42px; height:42px; object-fit:contain; border-radius:6px; display:block; cursor:pointer; }

    /* Social inline next to title */
    .social-inline { display:flex; align-items:center; gap:.5rem; margin-left:.4rem; flex:0 0 auto; }
    .social-inline button {
      width:44px; height:44px; border-radius:50%; border:none; padding:0; display:inline-flex;
      align-items:center; justify-content:center; cursor:pointer; background:rgba(255,255,255,0.95);
      color:#000; box-shadow:0 6px 18px rgba(0,0,0,0.28); overflow:hidden;
    }
    .social-inline img { width:70%; height:70%; object-fit:cover; display:block; border-radius:50%; image-rendering:auto; }

    /* Controls (selects + search) */
    .controls { display:flex; align-items:center; gap:0.6rem; margin-left:1rem; flex-wrap:wrap; }
    .controls select, .controls input {
      padding:.5rem .9rem; border:none; border-radius:8px; font-size:1rem; background:rgba(255,255,255,0.95); color:#000; min-width:150px; -webkit-appearance:none; appearance:none;
    }
    #search { width:220px; min-width:120px; }

    /* layout principal */
    .container{ max-width:1200px; margin:6rem auto 2rem; padding:0 2rem; z-index:6; position:relative; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:1.5rem; }
    .card{ border-radius:10px; overflow:hidden; position:relative; cursor:pointer; transition:all .6s ease; opacity:0; transform:translateY(30px); }
    .card.visible{ opacity:1; transform:translateY(0); }
    .card img{ width:100%; display:block; transition:transform .4s,filter .4s; }
    .card:hover img{ transform:scale(1.05); filter:brightness(75%); }
    .info{ position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); padding:.75rem; transform:translateY(100%); transition:transform .3s; }
    .card:hover .info{ transform:translateY(0); }

    /* Foreground container (fixed) */
    #fgContainer { position:fixed; z-index:8; pointer-events:auto; display:flex; align-items:center; justify-content:center; right:20px; bottom:20px; overflow:hidden; min-width:120px; min-height:80px; max-width:360px; max-height:640px; background:transparent; border-radius:10px; }
    @media (max-width:420px){ #fgContainer { right:12px; bottom:12px; max-width:220px; max-height:360px; } }
    #fgContainer canvas#fgCanvas, #fgContainer video#fgVideo{ width:100%; height:100%; display:block; pointer-events:none; object-fit:contain; border-radius:8px; }

    /* Snow (now sky-blue snowflake) canvas - full page overlay */
    #snowCanvas {
      position:fixed;
      left:0; top:0;
      width:100%; height:100%;
      pointer-events:none;
      z-index:30; /* encima de bg, pero debajo del header/iconos interactivos */
      mix-blend-mode:screen;
    }

    /* Decorations container (arbol, campanas, regalo, estrella) */
    #decorations {
      position:fixed;
      inset:0;
      pointer-events:none; /* que no interfieran con clicks */
      z-index:36; /* encima del snowCanvas, pero debajo del header (header z-index:40) */
    }
    /* √Årbol (esquina inferior izquierda) */
    .dec-tree {
      position:fixed;
      left:12px;
      bottom:12px;
      width:120px;
      max-width:22vw;
      z-index:36;
      transform-origin:center bottom;
      filter:drop-shadow(0 6px 16px rgba(0,0,0,0.5));
      pointer-events:none;
    }

    /* Regalo (esquina inferior derecha) */
    .dec-gift {
      position:fixed;
      right:14px;
      bottom:18px;
      width:92px;
      max-width:18vw;
      z-index:36;
      transform-origin:center bottom;
      pointer-events:none;
      animation: giftFloat 2800ms ease-in-out infinite;
    }
    @keyframes giftFloat {
      0% { transform: translateY(0) rotate(-1deg) scale(1); }
      50% { transform: translateY(-6px) rotate(2deg) scale(1.02); }
      100% { transform: translateY(0) rotate(-1deg) scale(1); }
    }

    /* Campanas (esquina superior derecha) */
    .dec-bells {
      position:fixed;
      right:12px;
      top:8px;
      width:82px;
      z-index:36;
      transform-origin:center top;
      pointer-events:none;
      animation: bellSwing 2200ms ease-in-out infinite;
    }
    @keyframes bellSwing {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(8deg); }
      50% { transform: rotate(0deg); }
      75% { transform: rotate(-6deg); }
      100% { transform: rotate(0deg); }
    }

    /* Estrella fugaz: estar√° posicionado en el DOM y animado con JS. */
    .shooting-star {
      position:fixed;
      z-index:36;
      pointer-events:none;
      width: 18px;
      height: 18px;
      opacity: 0;
      transform: translate(-50%, -50%) rotate(12deg);
      filter: drop-shadow(0 6px 18px rgba(255,255,210,0.08));
    }
    .shooting-tail {
      position:absolute;
      left:0; top:50%;
      width: 160px;
      height: 4px;
      transform-origin:left center;
      opacity:0.95;
      pointer-events:none;
      filter: blur(1px);
    }

    /* mobile adjustments */
    @media (max-width:420px) {
      .dec-tree { width:80px; left:8px; bottom:8px; }
      .dec-gift { width:72px; right:8px; bottom:10px; }
      .dec-bells { width:64px; right:8px; top:6px; }
      .shooting-tail { width:100px; height:3px; }
    }

    /* small helper for layering if needed */
    .decor-hidden-mobile { display:block; }
    @media (max-width:420px) {
      /* si queremos ocultar la estrella en m√≥viles, descomenta la siguiente l√≠nea */
      /* .decor-hidden-mobile { display:none; } */
    }

    /* mobile-select-popup and rest of previous styles are unchanged below... */
    .mobile-select-popup { position: absolute; z-index:1200; background: rgba(2,2,6,0.98); border:1px solid rgba(255,255,255,0.06); border-radius:8px; box-shadow:0 20px 60px rgba(0,0,0,0.6); max-height: 220px; min-width: 140px; overflow:auto; padding:0.2rem; font-size:0.92rem; -webkit-overflow-scrolling:touch; }
    .mobile-select-popup .opt { padding: .26rem .5rem; border-radius:6px; margin:.06rem 0; font-size:0.92rem; line-height:1.05; cursor:pointer; color:#eaeaea; }
    .mobile-select-popup .opt[aria-selected="true"], .mobile-select-popup .opt.selected { font-weight:700; background: rgba(255,255,255,0.03); }
    .mobile-select-popup .opt:hover { background: rgba(255,255,255,0.04); }

    /* more previous css preserved (cards, grid, etc.)... */
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .no-results { grid-column:1 / -1; padding:2.6rem; border-radius:14px; display:flex; gap:1.25rem; align-items:center; justify-content:center; flex-direction:column; background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.3)); border:1px solid rgba(255,255,255,0.04); box-shadow:0 18px 60px rgba(0,0,0,0.6); text-align:center; transition: transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .2s; }

    .play-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9; pointer-events:auto; display:none; }
    .play-btn{ background: rgba(0,0,0,0.7); color:#fff; border:2px solid #fff; padding:14px 22px; border-radius:12px; font-size:18px; cursor:pointer; }

  </style>
</head>
<body>

  <!-- V√≠deo de fondo -->
  <video id="bg-video" poster="videoframe.jpg" autoplay muted loop playsinline preload="auto">
    <source src="fondonavidad.mp4" type="video/mp4">
    Tu navegador no soporta v√≠deo.
  </video>
  <div id="overlay" aria-hidden="true"></div>

  <audio id="bg-music" autoplay></audio>

  <header>
    <h1>
      <img id="logo" src="Logo_Archinime.png" alt="Logo Archinime" onclick="location.reload()" title="Recargar p√°gina">
      Archinime
      <span class="social-inline" id="social-inline" title="S√≠guenos">
        <button id="youtube-btn" type="button" aria-label="Abrir YouTube en nueva pesta√±a" onclick="(function(e){ e.stopPropagation(); openInNewTab('https://www.youtube.com/@Archinime-k2g'); })(event)">
          <img src="youtube.jpg" alt="YouTube" loading="lazy" decoding="async">
        </button>
        <button id="tiktok-btn" type="button" aria-label="Abrir TikTok en nueva pesta√±a" onclick="(function(e){ e.stopPropagation(); openInNewTab('https://www.tiktok.com/@archinime?_t=ZS-8zGoKE4IqLw&_r=1'); })(event)">
          <img src="tiktok.jpg" alt="TikTok" loading="lazy" decoding="async">
        </button>
      </span>
    </h1>

    <!-- Controls agrupados -->
    <div class="controls" id="controls">
      <select id="genre-select" onchange="filtro()" aria-label="Seleccionar g√©nero">
        <option value="">Todos los g√©neros</option>
        <option>Acci√≥n</option>
        <option>Animaci√≥n</option>
        <option>Aventura</option>
        <option>Ciencia ficci√≥n</option>
        <option>Cocina</option>
        <option>Comedia</option>
        <option>Comedia oscura</option>
        <option>Cosplay</option>
        <option>Cyberpunk</option>
        <option>Deportivo</option>
        <option>Dibujo Animado</option>
        <option>Divulgaci√≥n Cient√≠fica</option>
        <option>Drama</option>
        <option>Ecchi</option>
        <option>Espionaje</option>
        <option>Escolar</option>
        <option>Fantas√≠a</option>
        <option>Fantas√≠a oscura</option>
        <option>Familiar</option>
        <option>Gore</option>
        <option>Harem</option>
        <option>Hentai</option>
        <option>Hist√≥rico</option>
        <option>Horror</option>
        <option>Incesto</option>
        <option>Infantil</option>
        <option>Isekai</option>
        <option>Isekai Inverso</option>
        <option>Kaiju</option>
        <option>Mah≈ç Sh≈çjo</option>
        <option>Mecha</option>
        <option>Militar</option>
        <option>Misterio</option>
        <option>Musical</option>
        <option>Nekketsu</option>
        <option>Parodia</option>
        <option>Policial</option>
        <option>Post-apocal√≠ptico</option>
        <option>Psicol√≥gico</option>
        <option>Reverse Harem</option>
        <option>Romance</option>
        <option>Romance escolar</option>
        <option>Slice of Life</option>
        <option>Sobrenatural</option>
        <option>Steampunk</option>
        <option>Superh√©roes</option>
        <option>Survival Game</option>
        <option>Tent√°culos</option>
        <option>Terror</option>
        <option>Terror psicol√≥gico</option>
        <option>Thriller</option>
        <option>Thriller psicol√≥gico</option>
        <option>Tokusatsu</option>
        <option>Tragedia</option>
        <option>Yaoi</option>
        <option>Yuri</option>
      </select>

      <select id="demographic-select" onchange="filtro()" aria-label="Seleccionar demograf√≠a">
        <option value="">Todas las demograf√≠as</option>
        <option>Gekiga</option>
        <option>Josei</option>
        <option>Kodomo</option>
        <option>Seijin</option>
        <option>Seinen</option>
        <option>Sh≈çjo</option>
        <option>Sh≈çnen</option>
      </select>

      <select id="rating-select" onchange="filtro()" aria-label="Seleccionar valoraci√≥n">
        <option value="">‚≠ê Todas</option>
        <option value="excellent">‚≠ê Excelente (4.8‚Äì5.0)</option>
        <option value="good">‚≠ê Buena (4.6‚Äì4.7)</option>
        <option value="regular">‚≠ê Regular (&lt;4.5)</option>
      </select>

      <input id="search" placeholder="üîç Buscar anime‚Ä¶" oninput="debouncedFiltro()" aria-label="Buscar anime">
    </div>

  </header>

  <main class="container">
    <div class="grid" id="grid"></div>
  </main>

  <!-- Foreground (chroma) -->
  <div class="stage" aria-hidden="true">
    <div id="fgContainer" aria-label="V√≠deo frontal">
      <canvas id="fgCanvas"></canvas>
      <video id="fgVideo" muted loop playsinline></video>
    </div>

    <div class="play-overlay" id="playOverlay" style="display:none;">
      <button class="play-btn" id="playBtn">Pulsar para iniciar</button>
    </div>
  </div>

  <!-- Snow canvas (se a√±adir√° desde JS) -->
  <canvas id="snowCanvas" aria-hidden="true"></canvas>

  <!-- Decorations: √°rbol, campanas, regalo, estrella -->
  <div id="decorations" aria-hidden="true">
    <!-- √Årbol de Navidad (SVG inline, no ocupa requests externas) -->
    <svg class="dec-tree" viewBox="0 0 120 150" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <linearGradient id="treeGrad" x1="0" x2="1"><stop offset="0%" stop-color="#0ed3ff"/><stop offset="60%" stop-color="#00ff9c"/><stop offset="100%" stop-color="#00d4ff"/></linearGradient>
      </defs>
      <g transform="translate(10,6)">
        <rect x="42" y="112" width="16" height="28" rx="2" fill="#8b5a2b"></rect>
        <g transform="translate(0,0)">
          <path d="M60 0 L20 48 L36 48 L12 84 L44 84 L20 120 L60 120 L100 120 L76 84 L108 84 L84 48 L100 48 Z" fill="url(#treeGrad)"></path>
          <!-- bolas -->
          <circle cx="42" cy="60" r="4" fill="#ff4d4d"></circle>
          <circle cx="76" cy="50" r="4" fill="#ffd700"></circle>
          <circle cx="56" cy="36" r="4" fill="#ff9f40"></circle>
          <circle cx="32" cy="88" r="3.5" fill="#ff6ad5"></circle>
          <circle cx="86" cy="88" r="3.5" fill="#00fff7"></circle>
          <!-- estrella en la punta -->
          <polygon points="60,6 64,18 76,18 66,26 70,38 60,30 50,38 54,26 44,18 56,18" fill="#fff176" stroke="#ffd700" stroke-width="0.6"></polygon>
        </g>
      </g>
    </svg>

    <!-- Regalo animado (SVG inline) -->
    <svg class="dec-gift" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <linearGradient id="giftGrad" x1="0" x2="1"><stop offset="0%" stop-color="#00f0ff"/><stop offset="100%" stop-color="#8bd3ff"/></linearGradient>
      </defs>
      <g transform="translate(0,0)">
        <rect x="12" y="30" width="76" height="56" rx="6" fill="url(#giftGrad)" stroke="#fff" stroke-opacity="0.12"></rect>
        <rect x="28" y="12" width="44" height="18" rx="4" fill="#ff6ad5" transform="rotate(-6,50,21)"></rect>
        <path d="M50 10 C46 26,56 26,50 34" fill="#ff4d4d" opacity="0.9"></path>
        <rect x="46" y="28" width="8" height="58" rx="2" fill="#ff4d4d"></rect>
        <rect x="12" y="46" width="76" height="8" rx="4" fill="#ffd700" opacity="0.95"></rect>
      </g>
    </svg>

    <!-- Campanas -->
    <svg class="dec-bells" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <g transform="translate(10,6)">
        <path d="M16 12 C10 14,6 20,6 28 L6 40 C6 52,40 56,40 56 L40 44 C40 36,36 28,30 26 L30 12 Z" fill="#ffd580" stroke="#ffb700" stroke-width="1.2"></path>
        <path d="M72 12 C66 14,62 20,62 28 L62 40 C62 52,96 56,96 56 L96 44 C96 36,92 28,86 26 L86 12 Z" fill="#ffd580" stroke="#ffb700" stroke-width="1.2"></path>
        <circle cx="26" cy="60" r="4" fill="#ff6a00"></circle>
        <circle cx="86" cy="60" r="4" fill="#ff6a00"></circle>
        <line x1="20" y1="4" x2="100" y2="4" stroke="rgba(255,255,255,0.05)" stroke-width="2"></line>
      </g>
    </svg>

    <!-- Estrella fugaz (se clona/posiciona desde JS para animarla) -->
    <svg id="star-template" class="shooting-star decor-hidden-mobile" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="display:none;" aria-hidden="true">
      <g>
        <circle cx="4" cy="4" r="4" fill="#fff9e0" opacity="0.98"></circle>
        <rect class="shooting-tail" x="8" y="3.5" width="140" height="4" rx="2" fill="url(#tailGrad)"></rect>
        <defs>
          <linearGradient id="tailGrad" x1="0" x2="1">
            <stop offset="0%" stop-color="#bff1ff" stop-opacity="0.9"/>
            <stop offset="60%" stop-color="#bff1ff" stop-opacity="0.6"/>
            <stop offset="100%" stop-color="#bff1ff" stop-opacity="0"/>
          </linearGradient>
        </defs>
      </g>
    </svg>

  </div>

  <script>
    /* ----------------------------
       FUNCIONES Y DATOS (l√≥gica conservada, con optimizaciones)
       ---------------------------- */
    function openInNewTab(url) {
      const win = window.open(url, '_blank', 'noopener,noreferrer');
      try { setTimeout(() => { if (typeof window.focus === 'function') win && win.focus(); }, 100); } catch(e){ console.warn(e); }
      return win;
    }
    function normalizeText(s) { return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase(); }

    function shuffleArray(arr){
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    /* ----------------------------
       Datos de animes (sin cambios)
       ---------------------------- */
    const animes = [
      {id:1, title:"DAN DA DAN", img:"dan.jpg", rating:4.9, genres:["Acci√≥n","Sobrenatural","Comedia","Romance","Comedia oscura","Sh≈çnen"]},
      {id:2, title:"Jujutsu Kaisen", img:"Jujutsu.jpg", rating:4.9, genres:["Sobrenatural","Fantas√≠a oscura","Acci√≥n","Nekketsu","Sh≈çnen"]},
      {id:3, title:"Konosuba", img:"konosubaportada.jpg", rating:4.8, genres:["Aventura","Comedia","Fantas√≠a","Sobrenatural","Isekai","Ecchi","Sh≈çnen"]},
      {id:4, title:"Re:Zero ‚àí Empezar vida en otro mundo", img:"rezero.png", rating:4.8, genres:["Acci√≥n","Aventura","Drama","Fantas√≠a oscura","Romance","Thriller psicol√≥gico","Terror psicol√≥gico","Isekai","Sh≈çnen"]},
      {id:5, title:"Mushoku Tensei", img:"mushoku.jpg", rating:4.8, genres:["Isekai","Ecchi","Romance","Harem","Acci√≥n","Aventura","Drama","Fantas√≠a","Seinen"]},
      {id:6, title:"Tensei Shitara Slime Datta Ken", aliases: ["That Time I Got Reincarnated as a Slime"], img:"slime.jpg", rating:4.9, genres:["Comedia","Isekai","Acci√≥n","Aventura","Fantas√≠a","Sh≈çnen"]},
      {id:7, title:"Saga of Tanya the Evil", aliases: ["Y≈çjo Senki"], img:"tanya1.jpg", rating:4.8, genres:["Acci√≥n","Aventura","Fantas√≠a","Militar","Drama","Ciencia ficci√≥n","Seinen"]},
      {id:8, title:"Akame Ga Kill", aliases: ["Akame ga Kiru"], img:"Akame1.jpg", rating:4.6, genres:["Acci√≥n","Aventura","Drama","Fantas√≠a oscura","Romance","Tragedia","Sh≈çnen"]},
      {id:9, title:"To Be Hero X", img:"hero11.jpg", rating:4.8, genres:["Acci√≥n","Comedia","Animaci√≥n","Fantas√≠a","Superh√©roes","Seinen"]},
      {id:10, title:"Demon Slayer", aliases: ["Kimetsu no Yaiba"], img:"demon.jpg", rating:4.9, genres:["Acci√≥n","Fantas√≠a oscura","Aventura","Sobrenatural","Drama","Sh≈çnen"]},
      {id:11, title:"Maou 2099", img:"maou2099portada.jpg", rating:4.7, genres:["Ciencia ficci√≥n","Isekai Inverso","Acci√≥n","Fantas√≠a","Cyberpunk","Sh≈çnen"]},
      {id:12, title:"Wistoria: Wand and Sword", img:"wistoria.jpg", rating:4.8, genres:["Fantas√≠a","Aventura","Sh≈çnen"]},
      {id:13, title:"Izure Saikyou no Renkinjutsushi", aliases: ["Possibly the Greatest Alchemist of All Time"], img:"Izure.jpg", rating:4.6, genres:["Aventura","Comedia","Fantas√≠a","Isekai","Sh≈çnen"]},
      {id:14, title:"Alya Sometimes Hides Her Feelings in Russian", aliases: ["Tokidoki Bosotto Russia-go de Dereru Tonari no Alya-san"], img:"alia.jpg", rating:4.8, genres:["Comedia","Romance","Romance escolar","Escolar","Josei"]},
      {id:15, title:"Reborn as a Vending Machine, I Now Wander the Dungeon", aliases: ["Jid≈çhanbaiki ni Umarekawatta Ore wa Meiky≈´ ni Samay≈ç"], img:"jidou.jpg", rating:4.1, genres:["Fantas√≠a","Isekai","Sh≈çnen"]},
      {id:16, title:"kimi to boku no saigo no senjou", aliases: ["Our Last Crusade or the Rise of a New World"], img:"kimi22222.jpg", rating:4.5, genres:["Acci√≥n","Fantas√≠a","Romance","Militar","Seinen"]},
      {id:17, title:"The Gorilla God's Go- To Girl", aliases: ["Gorilla no Kami Kara Kago Sareta Reij≈ç wa ≈åritsu Kishidan de Kawaiigareru"], img:"gorila11.jpg", rating:4.5, genres:["Fantas√≠a","Comedia","Escolar","Romance","Sh≈çjo"]},
      {id:18, title:"Chainsaw Man", img:"chaiportada.jpg", rating:4.9, genres:["Fantas√≠a oscura","Acci√≥n","Comedia oscura","Sh≈çnen"]},
      {id:19, title:"The Rising of the Shield Hero", aliases: ["Tate no Yuusha no Nariagari","El H√©roe del Escudo"], img:"heroedelescudoportada.jpg", rating:4.7, genres:["Aventura","Drama","Fantas√≠a","Acci√≥n","Romance","Isekai","Seinen"]},
      {id:20, title:"Overflow", img:"overflow.jpg", rating:4.6, genres:["Hentai","Escolar","Romance","Harem","Incesto","Seijin"]},
      {id:21, title:"Shiunji-ke no Kodomotachi", img:"Shiux.jpg", rating:4.6, genres:["Comedia","Romance","Drama","Harem","Slice of Life","Seinen"]},
      {id:22, title:"Goblin Slayer", img:"goblinslayerportada.jpg", rating:4.7, genres:["Fantas√≠a oscura","Horror","Aventura","Fantas√≠a","Seinen"]},
      {id:23, title:"Kanchigai no Atelier Meister", img:"atelier1.jpg", rating:4.6, genres:["Aventura","Comedia","Fantas√≠a","Acci√≥n","Sh≈çnen"]},
      {id:24, title:"Definitivamente. ¬°No me gusta mi hermano para nada!", img:"Oni.jpg", rating:4.1, genres:["Comedia","Romance","Slice of Life","Harem","Ecchi","Seinen"]},
      {id:25, title:"Kaiju No. 8", img:"kaijuportada.jpg", rating:4.9, genres:["Sobrenatural","Fantas√≠a oscura","Acci√≥n","Ciencia ficci√≥n","Aventura","Comedia","Kaiju","Sh≈çnen"]},
      {id:26, title:"Zootopia", img:"zootopiaportada.jpg", rating:4.7, genres:["Aventura","Comedia","Policial","Infantil","Familiar","Misterio","Animaci√≥n","Dibujo Animado","Kodomo"]},
      {id:27, title:"Clevatess -Majuu no Ou to Akago", img:"Clevatessportada.jpg", rating:4.8, genres:["Acci√≥n","Fantas√≠a","Drama","Seinen"]},
      {id:28, title:"Dr. Stone", img:"Dr._Stoneportada.jpg", rating:4.8, genres:["Ciencia ficci√≥n","Aventura","Comedia","Post-apocal√≠ptico","Sh≈çnen"]},
      {id:29, title:"One Piece (Live Action)", img:"onepieceportada.jpg", rating:4.8, genres:["Aventura","Comedia","Acci√≥n","Fantas√≠a","Drama","Sh≈çnen"]},
      {id:30, title:"Shoujo Ramune", img:"shoujoramuneportada.jpg", rating:4.3, genres:["Hentai","Harem","Incesto","Seijin"]},
      {id:31, title:"To Your Eternity", aliases: ["Fumetsu no Anata e"], img:"fumetsuportada.jpg", rating:4.8, genres:["Fantas√≠a","Drama","Aventura","Sobrenatural","Sh≈çnen"]},
      {id:32, title:"Tsugunai Subbed", img:"TsugunaiSubbed.jpg", rating:4.8, genres:["Hentai","Harem","Escolar","Seijin"]},
      {id:33, title:"Blue Lock", aliases: ["Yoichi Isagi"], img:"Bluelockportada.jpg", rating:4.8, genres:["Thriller","Psicol√≥gico","Deportivo","Survival Game","Sh≈çnen"]},
      {id:34, title:"Magic Maker: Isekai Mahou no Tsukurikata", aliases: ["Magic Maker: How to Make Magic in Another World"], img:"magic maker.jpg", rating:4.4, genres:["Fantas√≠a","Isekai","Aventura","Slice of Life","Sh≈çnen"]},
      {id:35, title:"Tsuyokute New Saga", aliases: ["New Saga"], img:"New Saga.jpg", rating:4.5, genres:["Fantas√≠a","Isekai","Aventura","Comedia","Acci√≥n","Drama","Slice of Life","Sh≈çnen"]},
      {id:36, title:"Gachiakuta", img:"Gachiakuta.jpg", rating:4.9, genres:["Fantas√≠a","Aventura","Acci√≥n","Fantas√≠a oscura","Sh≈çnen"]},
      {id:37, title:"Shinsei Kourin Dacryon Luna", img:"Shinsei Kourin Dacryon Luna portada.jpg", rating:4.0, genres:["Tent√°culos","Hentai","Fantas√≠a","Fantas√≠a oscura","Seijin"]},
      {id:38, title:"Kami-tachi ni Hirowareta Otoko", aliases: ["By the Grace of the Gods"], img:"Kamitachi.jpg", rating:4.7, genres:["Fantas√≠a","Aventura","Slice of Life","Isekai","Sh≈çnen"]},
      {id:39, title:"Ore dake Haireru Kakushi Dungeon", aliases: ["The Hidden Dungeon Only I Can Enter"], img:"oredake.jpg", rating:4.5, genres:["Fantas√≠a","Comedia","Harem","Ecchi","Acci√≥n","Romance","Sh≈çnen"]},
      {id:40, title:"One Punch-Man", aliases: ["One-Punch Man"], img:"onepunch.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Ciencia ficci√≥n","Superh√©roes","Seinen"]},
      {id:41, title:"Mashle", aliases: ["Mash Burnedead"], img:"mashle1.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Aventura","Sh≈çnen"]},
      {id:42, title:"Los Diarios de la Boticaria", aliases: ["Kusuriya no Hitorigoto","The Apothecary Diaries"], img:"maomaot1.jpg", rating:4.9, genres:["Drama","Misterio","Romance","Sh≈çjo"]},
      {id:43, title:"Maplestar", img:"pm.png", rating:5.0, genres:["Hentai","Animaci√≥n","Seijin"]},
      {id:44, title:"Uzumaki", img:"uzumakii.jpg", rating:4.2, genres:["Horror","Seinen"]},
      {id:45, title:"Tondemo Skill de Isekai Hourou Meshi", aliases: ["Campfire Cooking in Another World with My Absurd Skills"], img:"todemo.jpg", rating:4.9, genres:["Comedia","Fantas√≠a","Slice of Life","Cocina","Aventura","Sh≈çnen","Isekai"]},
      {id:46, title:"My Dress-Up Darling", aliases: ["Sono Bisque Doll wa Koi wo Suru"], img:"muneca.jpg", rating:4.9, genres:["Comedia","Romance","Slice of Life","Escolar","Cosplay","Seinen"]},
      {id:47, title:"Hazbin Hotel", aliases: ["Hotel Hazbin"], img:"hhzz.jpg", rating:4.8, genres:["Comedia","Musical","Drama","Animaci√≥n","Policial","Seijin"]},
      {id:48, title:"The Eminence in Shadow", aliases: ["Kage no Jitsuryokusha ni Naritakute!"], img:"shadow.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Isekai","Harem","Steampunk","Sh≈çnen"]},
      {id:49, title:"Spy √ó Family", img:"spy.jpg", rating:4.9, genres:["Comedia","Drama","Fantas√≠a","Familiar","Espionaje","Sh≈çnen"]},
      {id:50, title:"Black Clover", img:"portbla.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Fantas√≠a","Aventura","Sh≈çnen"]},
      {id:51, title:"My Hero Academia", aliases: ["Boku no Hero"], img:"sgsgsdseg.jpg", rating:4.7, genres:["Superh√©roes","Ciencia ficci√≥n","Comedia","Drama","Acci√≥n","Fantas√≠a","Escolar","Aventura","Sh≈çnen"]},
      {id:52, title:"Kakkou no Linazuke", aliases: ["A Couple of Cuckoos"], img:"pordf.jpg", rating:4.5, genres:["Romance","Comedia","Escolar","Harem","Sh≈çnen"]},
      {id:53, title:"Futari Solo Camp", aliases: ["Solo Camping for Two"], img:"futaripor.jpg", rating:4.5, genres:["Romance","Comedia","Slice of Life","Seinen"]},
      {id:54, title:"T≈çjima Tanzabur≈ç wa Kamen Rider ni Naritai", aliases: ["Tojima Wants to Be a Kamen Rider"], img:"tojima1.jpg", rating:4.8, genres:["Comedia","Acci√≥n","Tokusatsu","Seinen"]},
      {id:55, title:"Alma-chan wa Kazoku ni Naritai", aliases: ["Alma-chan Wants to Be a Family!"], img:"almachan.jpg", rating:4.6, genres:["Comedia","Romance","Ciencia ficci√≥n","Seinen"]},
    ];

    /* ----------------------------
       Renderizado (igual que antes)
       ---------------------------- */
    function render(list) {
      const grid = document.getElementById('grid');
      if (!list || list.length === 0) {
        grid.innerHTML = `
          <div class="no-results" role="status" aria-live="polite">
            <div class="title shimmer">¬°Ups! No se encontraron resultados que coincidan con la b√∫squeda.</div>
            <div class="subtitle">¬øNo lo encuentras? ü§î Puede que lo hayas escrito con un error ‚úèÔ∏è o que todav√≠a no lo haya subido ‚è≥.</div>
            <div class="sparkles"><button class="btn-reset" id="btn-reset">Entiendo üëå</button></div>
          </div>
        `;
        const btn = document.getElementById('btn-reset');
        if (btn) btn.addEventListener('click', () => {
          document.getElementById('search').value = '';
          document.getElementById('genre-select').value = '';
          document.getElementById('demographic-select').value = '';
          document.getElementById('rating-select').value = '';
          filtro();
          document.getElementById('search').focus();
        });
        return;
      }

      grid.innerHTML = list.map(a => `
        <div class="card" onclick="location='anime-detail.html?id=${a.id}'" role="link" tabindex="0">
          <img src="${a.img}" alt="${a.title}" loading="lazy" decoding="async">
          <div class="info"><strong>${a.title}</strong><span>‚≠ê ${a.rating ? (a.rating.toFixed? a.rating.toFixed(1): a.rating) : '‚Äî'}</span></div>
        </div>
      `).join('');

      const observer = new IntersectionObserver(entries => {
        entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('visible'); observer.unobserve(e.target); } });
      }, {threshold:0.2});
      document.querySelectorAll('.card').forEach(c => observer.observe(c));
    }

    function updateResultsCount(count){ const el = document.getElementById('results-count'); if (el) el.textContent = count; }
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    const debouncedFiltro = debounce(filtro, 200);

    function getBestTitleForSort(a){ const titles = [a.title].concat(a.aliases || []); const norm = titles.map(t=>normalizeText(t)); norm.sort(); return norm[0]; }

    function filtro(){
      const qRaw = document.getElementById('search').value || '';
      const q = qRaw.trim(); const qn = normalizeText(q);
      const g = document.getElementById('genre-select').value;
      const d = document.getElementById('demographic-select').value;
      const cat = document.getElementById('rating-select').value;

      const filtrados = animes.filter(a=>{
        const titles = [a.title].concat(a.aliases || []);
        const matchesText = !qn || titles.some(t => normalizeText(t).startsWith(qn));
        const byGenre = !g || a.genres && a.genres.includes(g);
        const byDemo  = !d || a.genres && a.genres.includes(d);
        let byRating = true;
        if (cat==='excellent') byRating = a.rating >= 4.8;
        else if (cat==='good') byRating = a.rating >= 4.6 && a.rating < 4.8;
        else if (cat==='regular') byRating = a.rating < 4.6;
        return matchesText && byGenre && byDemo && byRating;
      });

      let resultList = filtrados.slice();
      if (qn) {
        resultList.sort((A,B)=>{
          const titlesA = [A.title].concat(A.aliases||[]).map(t=>normalizeText(t));
          const titlesB = [B.title].concat(B.aliases||[]).map(t=>normalizeText(t));
          const aStarts = titlesA.some(t=>t.startsWith(qn));
          const bStarts = titlesB.some(t=>t.startsWith(qn));
          if (aStarts !== bStarts) return aStarts ? -1 : 1;
          const na = getBestTitleForSort(A); const nb = getBestTitleForSort(B);
          return na < nb ? -1 : na > nb ? 1 : 0;
        });
      } else {
        resultList.sort((A,B)=> normalizeText(A.title) < normalizeText(B.title) ? -1 : normalizeText(A.title) > normalizeText(B.title) ? 1 : 0);
      }

      render(resultList);
      updateResultsCount(resultList.length);
    }

    // inicial -> ahora en orden ALEATORIO
    render(shuffleArray(animes));
    updateResultsCount(animes.length);

    document.getElementById('search').addEventListener('input', debouncedFiltro);
    document.getElementById('search').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); filtro(); } });
    const genreEl = document.getElementById('genre-select');
    if (genreEl) genreEl.addEventListener('change', filtro);
    const ratingEl = document.getElementById('rating-select');
    if (ratingEl) ratingEl.addEventListener('change', filtro);
    const demoEl = document.getElementById('demographic-select');
    if (demoEl) demoEl.addEventListener('change', filtro);

    /* ----------------------------
       Mobile custom popup for selects (sin cambios funcionales)
       ---------------------------- */
    function isMobileScreen(){ return window.matchMedia && window.matchMedia('(max-width:780px)').matches; }

    (function setupMobileSelectPopups(){
      const selects = ['genre-select','demographic-select','rating-select'].map(id=>document.getElementById(id)).filter(Boolean);
      let activePopup = null;
      let popupInteracting = false;
      let rafIdForReposition = null;

      function closePopup(){
        if (activePopup && activePopup.popup) {
          try { activePopup.popup.remove(); } catch(e){}
          popupInteracting = false;
          document.body.style.touchAction = '';
          activePopup = null;
        }
      }

      function onOutsideClick(e){
        if (!activePopup) return;
        if (!activePopup.popup.contains(e.target) && e.target !== activePopup.el) closePopup();
      }

      function repositionActivePopup(){
        if (!activePopup) return;
        if (rafIdForReposition) cancelAnimationFrame(rafIdForReposition);
        rafIdForReposition = requestAnimationFrame(()=> {
          try {
            const selectEl = activePopup.el;
            const popup = activePopup.popup;
            const rect = selectEl.getBoundingClientRect();
            const popupRect = popup.getBoundingClientRect();
            let top = rect.bottom + 6;
            let left = rect.left;
            if (left + popupRect.width > window.innerWidth - 8) { left = Math.max(8, window.innerWidth - popupRect.width - 8); }
            if (top + popupRect.height > window.innerHeight - 8) {
              top = rect.top - popupRect.height - 6;
              if (top < 8) top = 8;
            }
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
          } catch(err){ /* no romper si algo falla */ }
        });
      }

      window.addEventListener('resize', ()=> { if (activePopup) repositionActivePopup(); }, {passive:true});
      window.addEventListener('scroll', ()=> { if (activePopup) repositionActivePopup(); }, {passive:true});

      document.addEventListener('click', onOutsideClick);

      selects.forEach(sel => {
        sel.addEventListener('touchstart', function(ev){
          if (!isMobileScreen()) return;
          ev.preventDefault();
          if (activePopup && activePopup.el === sel) { closePopup(); return; }
          openMobilePopupFor(sel);
        }, {passive:false});
        sel.addEventListener('mousedown', function(ev){
          if (!isMobileScreen()) return;
          ev.preventDefault();
          if (activePopup && activePopup.el === sel) { closePopup(); return; }
          openMobilePopupFor(sel);
        });
      });

      function openMobilePopupFor(selectEl){
        closePopup();
        const rect = selectEl.getBoundingClientRect();
        const popup = document.createElement('div');
        popup.className = 'mobile-select-popup';
        popup.setAttribute('role','listbox');
        Array.from(selectEl.options).forEach((opt,i) => {
          const item = document.createElement('div');
          item.className = 'opt';
          item.setAttribute('role','option');
          item.setAttribute('data-value', opt.value);
          item.textContent = opt.textContent;
          if (opt.selected) item.setAttribute('aria-selected','true');
          item.addEventListener('click', ()=> {
            selectEl.value = opt.value;
            const ev = new Event('change', { bubbles: true });
            selectEl.dispatchEvent(ev);
            popup.querySelectorAll('.opt').forEach(o=>o.removeAttribute('aria-selected'));
            item.setAttribute('aria-selected','true');
            setTimeout(()=> closePopup(), 60);
          });
          popup.appendChild(item);
        });

        popup.addEventListener('touchstart', ()=> { popupInteracting = true; });
        popup.addEventListener('pointerdown', ()=> { popupInteracting = true; });
        popup.addEventListener('touchend', ()=> { setTimeout(()=> { popupInteracting = false; }, 180); });
        popup.addEventListener('pointerup', ()=> { setTimeout(()=> { popupInteracting = false; }, 100); });

        document.body.appendChild(popup);
        popup.style.position = 'fixed';

        function place() {
          const popupRect = popup.getBoundingClientRect();
          let top = rect.bottom + 6;
          let left = rect.left;
          if (left + popupRect.width > window.innerWidth - 8) { left = Math.max(8, window.innerWidth - popupRect.width - 8); }
          if (top + popupRect.height > window.innerHeight - 8) {
            top = rect.top - popupRect.height - 6;
            if (top < 8) top = 8;
          }
          popup.style.left = left + 'px';
          popup.style.top = top + 'px';
        }

        setTimeout(()=> { place(); }, 20);

        activePopup = { el: selectEl, popup };

        setTimeout(()=> { repositionActivePopup(); }, 80);
      }
    })();


    /* ----------------------------
       Ajuste din√°mico del espacio entre header y la grid en m√≥viles (igual)
       ---------------------------- */
    function isMobileScreenSmall(){ return window.matchMedia && window.matchMedia('(max-width:767px)').matches; }

    function adjustMobileSpacing(){
      try {
        const container = document.querySelector('.container');
        const header = document.querySelector('header');
        const grid = document.querySelector('.grid');
        if (!container || !header || !grid) return;
        if (!isMobileScreenSmall()) {
          container.style.marginTop = '';
          return;
        }
        const headerH = Math.ceil(header.getBoundingClientRect().height);
        const smallPhone = window.matchMedia && window.matchMedia('(max-width:420px)').matches;
        const extraGap = smallPhone ? 4 : 6;
        container.style.marginTop = (headerH + extraGap) + 'px';
      } catch(e){
        console.warn('adjustMobileSpacing error', e);
      }
    }

    window.addEventListener('DOMContentLoaded', ()=> {
      adjustMobileSpacing();
      setTimeout(adjustMobileSpacing, 180);
    });
    window.addEventListener('resize', ()=> { adjustMobileSpacing(); }, {passive:true});


    /* ----------------------------
       Fondo y audio (primera pista aleatoria luego secuencial)
       ---------------------------- */
    window.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('bg-video');
      const overlay = document.getElementById('overlay');
      try { video.preload = video.getAttribute('preload') || 'auto'; } catch(e){ console.warn(e); }
      video.muted = true; video.playsInline = true;
      const revealVideo = () => { video.style.opacity = '1'; overlay.style.opacity = '0'; };
      overlay.addEventListener('transitionend', (ev) => { if (ev.propertyName === 'opacity' && getComputedStyle(overlay).opacity === '0') overlay.style.display = 'none'; });
      video.addEventListener('playing', () => { revealVideo(); }, { once: true });
      video.addEventListener('canplaythrough', () => { video.play().catch(()=>{}); }, { once: true });
      video.addEventListener('loadeddata', () => { video.play().catch(()=>{}); }, { once: true });
    });

    window.addEventListener('DOMContentLoaded', () => {
      const audio = document.getElementById('bg-music');
      const musicList = [
        'Rakion Music Evento De Navidad 03.mp3',
        'Rakion Music Evento De Navidad 02.mp3',
        'Rakion Music Evento De Navidad 01.mp3',
      ];

      let currentMusicIndex = Math.floor(Math.random() * musicList.length);
      function playByIndex(idx) {
         if (!musicList || musicList.length === 0) return;
         currentMusicIndex = ((idx % musicList.length) + musicList.length) % musicList.length;
         audio.src = musicList[currentMusicIndex];
         audio.load();
         audio.volume = 0.75;
         audio.play().catch(()=> {
           document.addEventListener('click', ()=>{ audio.play().catch(()=>{}); }, { once: true });
         });
      }
      audio.addEventListener('ended', ()=> {
         currentMusicIndex = (currentMusicIndex + 1) % musicList.length;
         playByIndex(currentMusicIndex);
      });
      playByIndex(currentMusicIndex);
    });

    /* ----------------------------
       Chroma + FG logic + fuegos artificiales (sin cambios funcionales)
       ---------------------------- */
    const fgContainer = document.getElementById('fgContainer');
    const fgCanvas = document.getElementById('fgCanvas');
    const fgVideo = document.getElementById('fgVideo');
    const bgVideo = document.getElementById('bg-video');
    const bgMusic = document.getElementById('bg-music');
    const ctx = fgCanvas.getContext ? fgCanvas.getContext('2d', { alpha: true }) : null;

    let off = document.createElement('canvas');
    let offCtx = off.getContext('2d');
    let animationId = null;
    let usingChroma = true;
    let scheduledTimer = null;
    let currentVideoObj = null;
    let lastObjectUrl = null;
    let isAnimatingExplosion = false;
    let visibilityPaused = false;

    const videoList = [
      { id: 'hola', src: 'hola.mp4', preset: { threshold: 0.25, diff: 0, soft: 100 } },
      { id: 'rem',  src: 'rem.mp4',  preset: { threshold: 0.10, diff: 0, soft: 100  } },

      // Animaciones navide√±as (pantalla verde)
      { id: 'animacionnavidad1', src: 'animacionnavidad1.mp4', preset: { threshold: 0.10, diff: 0, soft: 100 }, keyColor: 'green' },
      { id: 'animacionnavidad2', src: 'animacionnavidad2.mp4', preset: { threshold: 0.10, diff: 0, soft: 100 }, keyColor: 'green' },
      { id: 'animacionnavidad3', src: 'animacionnavidad3.mp4', preset: { threshold: 0.10, diff: 0, soft: 100 }, keyColor: 'green' },
      { id: 'animacionnavidad4', src: 'animacionnavidad4.mp4', preset: { threshold: 0.10, diff: 0, soft: 100 }, keyColor: 'green' },

      // Animaciones navide√±as (pantalla azul)
      { id: 'animacionnavidad5', src: 'animacionnavidad5.mp4', preset: { threshold: 0.12, diff: 0, soft: 100 }, keyColor: 'blue' },
      { id: 'animacionnavidad6', src: 'animacionnavidad6.mp4', preset: { threshold: 0.12, diff: 0, soft: 100 }, keyColor: 'blue' }
    ];

    function pickRandomVideo(excludeId){
      if (!videoList || videoList.length === 0) return null;
      if (videoList.length === 1) return videoList[0];
      const candidates = videoList.filter(v => v.id !== excludeId);
      if (candidates.length === 0) return videoList[Math.floor(Math.random()*videoList.length)];
      return candidates[Math.floor(Math.random()*candidates.length)];
    }

    function placeRandomSide(infoObj){
      const side = Math.random() < 0.5 ? 'left' : 'right';
      const margin = window.matchMedia('(max-width:767px)').matches ? '12px' : '20px';
      if (side === 'left') { fgContainer.style.left = margin; fgContainer.style.right = ''; }
      else { fgContainer.style.right = margin; fgContainer.style.left = ''; }
    }

    function adjustContainerToVideo(video, infoObj){
      const vw = video.videoWidth || 16; const vh = video.videoHeight || 9;
      let maxW = Math.min(window.innerWidth * 0.32, 360);
      let maxH = Math.min(window.innerHeight * 0.4, 640);

      if (window.matchMedia('(max-width:767px)').matches) {
        if (infoObj && infoObj.id === 'rem') {
          maxW = Math.min(window.innerWidth * 0.30, 180);
          maxH = Math.min(window.innerHeight * 0.30, 200);
        } else if (infoObj && infoObj.id === 'hola') {
          maxW = Math.min(window.innerWidth * 0.62, 380);
          maxH = Math.min(window.innerHeight * 0.62, 520);
        } else {
          maxW = Math.min(window.innerWidth * 0.45, 260);
          maxH = Math.min(window.innerHeight * 0.45, 420);
        }
      } else {
        maxW = Math.min(window.innerWidth * 0.32, 360);
        maxH = Math.min(window.innerHeight * 0.4, 640);
      }

      const scale = Math.min(maxW / vw, maxH / vh, 1.0);
      const displayW = Math.max(120, Math.round(vw * scale)); const displayH = Math.max(80, Math.round(vh * scale));
      fgContainer.style.width = displayW + 'px'; fgContainer.style.height = displayH + 'px';
      fgCanvas.width = displayW; fgCanvas.height = displayH;
      const cap = 1280;
      off.width = Math.min(video.videoWidth || displayW * 2, cap);
      off.height = Math.min(video.videoHeight || displayH * 2, cap);
      resizeFireCanvas();
    }

    // chroma key
    function applyChromaKey(imageData, settings, keyColor = 'green'){
      const data = imageData.data; const len = data.length;
      const thresh = settings.threshold ?? 0.4; const minDiff = settings.diff ?? 30; const soften = settings.soft ?? 30;
      for (let i = 0; i < len; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
        if (a === 0) continue;
        const sum = r + g + b + 1;
        if (keyColor === 'blue') {
          const maxrg = Math.max(r, g);
          const blueScore = (b - maxrg) / sum;
          const isBlueCandidate = (b - maxrg) > minDiff && blueScore > (thresh - 0.2);
          if (!isBlueCandidate) { data[i+3] = 255; continue; }
          const diff = b - maxrg;
          if (soften <= 0) data[i+3] = (diff > minDiff) ? 0 : 255;
          else {
            const t = (diff - minDiff) / soften;
            const clamped = Math.max(0, Math.min(1, t));
            data[i+3] = Math.round((1 - clamped) * 255);
          }
        } else {
          const maxrb = Math.max(r, b);
          const greenScore = (g - maxrb) / sum;
          const isGreenCandidate = (g - maxrb) > minDiff && greenScore > (thresh - 0.2);
          if (!isGreenCandidate) { data[i+3] = 255; continue; }
          const diff = g - maxrb;
          if (soften <= 0) data[i+3] = (diff > minDiff) ? 0 : 255;
          else {
            const t = (diff - minDiff) / soften;
            const clamped = Math.max(0, Math.min(1, t));
            data[i+3] = Math.round((1 - clamped) * 255);
          }
        }
      }
      return imageData;
    }

    function drawProcessedToScreen(){
      if (!ctx) return;
      const cw = fgCanvas.width, ch = fgCanvas.height;
      const vw = off.width, vh = off.height;
      ctx.clearRect(0,0,cw,ch);
      if (vw === 0 || vh === 0) return;
      const scale = Math.min(cw / vw, ch / vh);
      const dw = Math.round(vw * scale); const dh = Math.round(vh * scale);
      const dx = Math.round((cw - dw) / 2); const dy = Math.round((ch - dh) / 2);
      ctx.drawImage(off, 0, 0, vw, vh, dx, dy, dw, dh);
    }

    function processLoop(video, infoObj){
      if (!usingChroma || visibilityPaused) { animationId = requestAnimationFrame(()=>processLoop(video, infoObj)); return; }
      if (video.paused || video.ended) { animationId = requestAnimationFrame(()=>processLoop(video, infoObj)); return; }
      if (video.videoWidth && video.videoHeight && (off.width !== Math.min(video.videoWidth,1280) || off.height !== Math.min(video.videoHeight,1280))) {
        off.width = Math.min(video.videoWidth,1280); off.height = Math.min(video.videoHeight,1280);
      }
      try { offCtx.drawImage(video, 0, 0, off.width, off.height); } catch (err) {
        usingChroma = false; fgCanvas.style.display = 'none'; fgVideo.style.display = 'block';
        if (animationId) cancelAnimationFrame(animationId);
        fgVideo.play().catch(()=>{ document.getElementById('playOverlay').style.display = 'flex'; });
        return;
      }
      let frame;
      try { frame = offCtx.getImageData(0,0,off.width,off.height); } catch (err) {
        usingChroma = false; fgCanvas.style.display = 'none'; fgVideo.style.display = 'block';
        if (animationId) cancelAnimationFrame(animationId);
        fgVideo.play().catch(()=>{ document.getElementById('playOverlay').style.display = 'flex'; });
        return;
      }
      const settings = infoObj && infoObj.preset ? infoObj.preset : { threshold:0.4, diff:30, soft:30 };
      const keyColor = infoObj && infoObj.keyColor ? infoObj.keyColor : 'green';
      const processed = applyChromaKey(frame, settings, keyColor);
      offCtx.putImageData(processed, 0, 0);
      drawProcessedToScreen();
      animationId = requestAnimationFrame(()=>processLoop(fgVideo, infoObj));
    }

    function showContainer(){ fgContainer.style.display = 'flex'; fgContainer.classList.remove('exit'); fgContainer.classList.add('enter'); }
    function hideContainerInstantlyForTransition(){ fgContainer.classList.remove('enter'); fgContainer.classList.add('exit'); }

    function scheduleNextVideo(afterSeconds = 3, excludeId = null){
      if (scheduledTimer){ clearTimeout(scheduledTimer); scheduledTimer = null; }
      hideContainerInstantlyForTransition();
      scheduledTimer = setTimeout(()=>{ const next = pickRandomVideo(excludeId); if (!next) return; playVideoClip(next); }, afterSeconds*1000);
    }

    /* ----------------------------
       FUEGOS ARTIFICIALES (canvas, part√≠culas) - igual
       ---------------------------- */
    const fireCanvas = document.createElement('canvas');
    fireCanvas.className = 'firework-canvas';
    fireCanvas.style.position = 'absolute';
    fireCanvas.style.left = '0';
    fireCanvas.style.top = '0';
    fireCanvas.style.width = '100%';
    fireCanvas.style.height = '100%';
    fireCanvas.style.zIndex = '9999';
    fireCanvas.style.pointerEvents = 'none';
    fgContainer.appendChild(fireCanvas);
    const fctx = fireCanvas.getContext('2d');

    function resizeFireCanvas(){
      const rect = fgContainer.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width * devicePixelRatio));
      const h = Math.max(1, Math.floor(rect.height * devicePixelRatio));
      if (fireCanvas.width !== w || fireCanvas.height !== h) {
        fireCanvas.width = w;
        fireCanvas.height = h;
        fireCanvas.style.width = rect.width + 'px';
        fireCanvas.style.height = rect.height + 'px';
        fctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      }
    }
    window.addEventListener('resize', resizeFireCanvas, {passive:true});
    setTimeout(resizeFireCanvas, 120);

    function random(min, max){ return Math.random()*(max-min)+min; }

    function explodeParticlesAt(x, y, colors, count=60, duration=650){
      const particles = [];
      for (let i=0;i<count;i++){
        const angle = random(0, Math.PI*2);
        const speed = random(1.6, 7.2);
        particles.push({
          x, y,
          vx: Math.cos(angle) * speed * random(0.6,1.2),
          vy: Math.sin(angle) * speed * random(0.6,1.2) - random(0.8,2.6),
          life: random(duration*0.7, duration*1.05),
          age: 0,
          radius: random(2,5),
          color: colors[Math.floor(Math.random()*colors.length)]
        });
      }
      const start = performance.now();
      return new Promise(resolve => {
        function frame(now){
          const t = now - start;
          fctx.clearRect(0,0,fireCanvas.width,fireCanvas.height);
          for (let p of particles){
            p.age = t;
            const lifeRatio = Math.max(0, 1 - p.age / p.life);
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.18;
            const alpha = Math.max(0, Math.min(1, lifeRatio));
            fctx.globalAlpha = alpha;
            fctx.beginPath();
            fctx.fillStyle = p.color;
            fctx.arc(p.x, p.y, p.radius * (0.6 + lifeRatio * 0.8), 0, Math.PI*2);
            fctx.fill();
            fctx.globalAlpha = alpha * 0.22;
            fctx.beginPath();
            fctx.fillStyle = p.color;
            fctx.arc(p.x, p.y, (p.radius*6) * (0.2 + (1-lifeRatio)*0.9), 0, Math.PI*2);
            fctx.fill();
          }
          fctx.globalAlpha = 1;
          if (t < duration){
            requestAnimationFrame(frame);
          } else {
            fctx.clearRect(0,0,fireCanvas.width,fireCanvas.height);
            resolve();
          }
        }
        requestAnimationFrame(frame);
      });
    }

    async function doFireworkThenHide(){
      if (isAnimatingExplosion) return;
      isAnimatingExplosion = true;
      try { fgVideo.pause(); } catch(e){}
      const rect = fgContainer.getBoundingClientRect();
      const cx = rect.width / 2;
      const cy = rect.height / 2;
      resizeFireCanvas();
      const palette = ['#ffcc00','#ff4d4d','#ffd700','#00fff7','#ff6ad5','#ff7f50','#8b5cf6'];
      fgContainer.style.transition = 'transform .25s ease-out, opacity .25s ease';
      fgContainer.style.transform = 'scale(0.96)';
      fgContainer.style.opacity = '0.85';
      await explodeParticlesAt(cx, cy, palette, 80, 700);
      fgContainer.style.opacity = '0';
      fgContainer.style.transform = 'scale(.8) translateY(10px)';
      await new Promise(r => setTimeout(r, 220));
      fgContainer.style.display = 'none';
      fgContainer.style.transform = '';
      fgContainer.style.opacity = '';
      isAnimatingExplosion = false;
    }

    /* ----------------------------
       Reproducci√≥n robusta y sin pausar la m√∫sica (igual)
       ---------------------------- */
    async function playVideoClip(infoObj){
      if (!infoObj) return;
      currentVideoObj = infoObj;
      usingChroma = true;
      if (lastObjectUrl) { try { URL.revokeObjectURL(lastObjectUrl); } catch(e){}; lastObjectUrl = null; }

      fgVideo.src = infoObj.src;
      fgVideo.load();

      const onMeta = () => {
        fgVideo.removeEventListener('loadedmetadata', onMeta);
        if (infoObj.id === 'hola') { fgContainer.style.bottom = '0px'; }
        else { fgContainer.style.bottom = '20px'; }
        placeRandomSide(infoObj);
        adjustContainerToVideo(fgVideo, infoObj);
        fgCanvas.style.display = 'block';
        fgVideo.style.display = 'none';
        fgVideo.play().catch(()=>{});
        bgVideo.play().catch(()=>{});
        if (!animationId && usingChroma && !visibilityPaused) animationId = requestAnimationFrame(()=>processLoop(fgVideo, infoObj));
        showContainer();
      };

      fgVideo.addEventListener('loadedmetadata', onMeta);

      fgVideo.onerror = (e) => {
        usingChroma = false;
        fgCanvas.style.display = 'none';
        fgVideo.style.display = 'block';
        fgVideo.play().catch(()=>{ document.getElementById('playOverlay').style.display = 'flex'; });
      };

      fgVideo.onended = () => {
        scheduleNextVideo(3, infoObj.id);
      };
    }

    // Click en contenedor dispara fuegos y siguiente clip
    fgContainer.addEventListener('click', async (ev)=>{
      if (isAnimatingExplosion) return;
      if (scheduledTimer){ clearTimeout(scheduledTimer); scheduledTimer = null; }
      usingChroma = false;
      if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
      await doFireworkThenHide();
      const currentId = currentVideoObj ? currentVideoObj.id : null;
      const next = pickRandomVideo(currentId);
      setTimeout(()=> { playVideoClip(next); }, 420);
    });

    document.getElementById('playBtn').addEventListener('click', ()=>{
      document.getElementById('playOverlay').style.display = 'none';
      bgVideo.play().catch(()=>{}); fgVideo.play().catch(()=>{});
      try { bgMusic.play().catch(()=>{}); } catch(e){}
    });

    // Throttled resize
    let resizeRaf = null;
    window.addEventListener('resize', ()=> {
      if (resizeRaf) return;
      resizeRaf = requestAnimationFrame(()=> {
        resizeFireCanvas();
        if (currentVideoObj && fgVideo.videoWidth && fgVideo.videoHeight) {
          adjustContainerToVideo(fgVideo, currentVideoObj);
        }
        resizeRaf = null;
      });
    }, {passive:true});

    // Visibility change optimization
    document.addEventListener('visibilitychange', ()=> {
      if (document.hidden) {
        visibilityPaused = true;
        if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
      } else {
        visibilityPaused = false;
        if (usingChroma && fgVideo && !animationId) {
          animationId = requestAnimationFrame(()=>processLoop(fgVideo, currentVideoObj));
        }
      }
    }, {passive:true});

    function init(){
      fgContainer.style.display = 'none'; fgCanvas.style.display = 'none'; fgVideo.style.display = 'none';
      const first = pickRandomVideo(null);
      if (!first) return;
      playVideoClip(first);
    }

    init();

    window.addEventListener('beforeunload', ()=>{ if (lastObjectUrl) try{ URL.revokeObjectURL(lastObjectUrl); } catch(e){}; });

    /* ----------------------------
       NIEVE -> Copos celestes con forma (canvas)
       - Optimizado: densidad adaptativa y pausa en background
       ---------------------------- */
    (function initBlueSnow(){
      const canvas = document.getElementById('snowCanvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      let w = 0, h = 0;
      let particles = [];
      const baseMax = 160; // densidad base en pantallas grandes
      const windBase = 0.12;

      function resize(){
        const rectW = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const rectH = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        w = Math.floor(rectW);
        h = Math.floor(rectH);
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }

      function makeSnowflake(i){
        // tama√±o adaptativo: un poco de variedad
        const size = (Math.random() * 2.8 + (Math.random() < 0.08 ? 2.6 : 0.6));
        return {
          x: Math.random() * w,
          y: Math.random() * h - h * Math.random(),
          vx: (Math.random() - 0.5) * 0.4 + windBase * (Math.random() - 0.5),
          vy: 0.4 + Math.random() * 1.1,
          size: size,
          opacity: Math.random() * 0.45 + 0.35,
          rotation: Math.random() * Math.PI * 2,
          spin: (Math.random() - 0.5) * 0.03,
          swing: Math.random()*0.8 + 0.2
        };
      }

      function initParticles(){
        particles = [];
        // densidad seg√∫n pantalla (reduce en m√≥viles)
        const screenFactor = Math.max(0.4, Math.min(1.0, (w*h) / (1366*768)));
        let target = Math.floor(baseMax * screenFactor);
        if (window.matchMedia && window.matchMedia('(max-width:420px)').matches) {
          target = Math.max(22, Math.floor(target * 0.35)); // menos densidad en m√≥viles peque√±os
        }
        for (let i=0;i<target;i++) particles.push(makeSnowflake(i));
      }

      // dibuja un copo 'estilizado' (peque√±o hex/star)
      function drawSnowflake(px, py, size, rotation, opacity){
        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(rotation);
        ctx.globalAlpha = opacity;
        // color celeste suave
        ctx.fillStyle = "rgba(170,240,255,0.95)";
        ctx.strokeStyle = "rgba(140,220,255,0.9)";
        ctx.lineWidth = Math.max(0.8, size * 0.08);
        // simple dise√±o: 6 brazos
        for (let k=0;k<6;k++){
          ctx.beginPath();
          ctx.moveTo(0,0);
          ctx.lineTo(0, -size);
          ctx.stroke();
          ctx.beginPath();
          ctx.arc(0, -size*0.9, Math.max(0.6, size*0.15), 0, Math.PI*2);
          ctx.fill();
          ctx.rotate(Math.PI/3);
        }
        // central point
        ctx.beginPath();
        ctx.arc(0,0, Math.max(0.8, size*0.12), 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
      }

      let lastTime = performance.now();
      let running = true;

      function step(now){
        if (!running) return;
        const dt = Math.min(50, now - lastTime);
        lastTime = now;
        ctx.clearRect(0,0,w,h);

        for (let p of particles){
          // movimiento
          p.x += p.vx * (dt/16);
          p.y += p.vy * (dt/16);
          p.rotation += p.spin * (dt/16);
          // ligero swing para parecer copo real
          p.x += Math.sin(now/800 + p.rotation) * (p.swing * 0.02);

          // si sale de pantalla -> reubicar arriba con variaci√≥n
          if (p.y > h + 12 || p.x < -30 || p.x > w + 30) {
            p.x = Math.random() * w;
            p.y = -8 - Math.random() * 40;
            p.vx = (Math.random() - 0.5) * 0.4 + windBase * (Math.random() - 0.5);
            p.vy = 0.4 + Math.random() * 1.1;
            p.rotation = Math.random() * Math.PI * 2;
          }
          drawSnowflake(p.x, p.y, p.size, p.rotation, p.opacity);
        }
        requestAnimationFrame(step);
      }

      // pausa cuando la pesta√±a no es visible para ahorro
      document.addEventListener('visibilitychange', ()=> {
        if (document.hidden) running = false;
        else { running = true; lastTime = performance.now(); requestAnimationFrame(step); }
      });

      window.addEventListener('resize', ()=> { resize(); initParticles(); }, {passive:true});
      resize();
      initParticles();
      requestAnimationFrame(step);
    })();

    /* ----------------------------
       Estrella fugaz (JS) - se crea y anima de vez en cuando
       ---------------------------- */
    (function shootingStarController(){
      const template = document.getElementById('star-template');
      if (!template) return;
      const container = document.getElementById('decorations');
      // frecuencia: cada 7-14s
      function spawnOne(){
        const clone = template.cloneNode(true);
        clone.style.display = 'block';
        clone.id = '';
        clone.classList.add('shooting-star');
        // random start: fuera a la izquierda superior (y entre 8% y 26% altura)
        const startY = Math.random() * (window.innerHeight * 0.22) + (window.innerHeight * 0.06);
        const startX = -40;
        // end somewhere to the right (diagonal down)
        const endX = window.innerWidth + 60;
        const travelY = startY - (Math.random() * (window.innerHeight * 0.12) + 30); // ligera curva hacia arriba
        container.appendChild(clone);

        // position initial
        clone.style.left = startX + 'px';
        clone.style.top = startY + 'px';
        clone.style.opacity = '0';

        // tail color gradiente ya definido en template
        const tail = clone.querySelector('.shooting-tail');
        if (tail) {
          tail.style.fill = 'url(#tailGrad)';
        }

        // animation params
        const duration = 900 + Math.random()*600; // 0.9s - 1.5s
        const start = performance.now();
        // animate along a bezier-ish path
        function animate(now){
          const t = Math.min(1, (now - start) / duration);
          // ease out
          const ease = 1 - Math.pow(1 - t, 3);
          const x = startX + (endX - startX) * ease;
          const y = startY + (travelY - startY) * ease;
          clone.style.left = x + 'px';
          clone.style.top = y + 'px';
          clone.style.opacity = (t < 0.08 ? t/0.08 : 1 - Math.max(0, (t-0.8)/0.2) );
          // shorten tail while moving
          const tailEl = clone.querySelector('.shooting-tail');
          if (tailEl) {
            const tailLen = 140 * (1 - t*0.85);
            tailEl.setAttribute('width', tailLen);
            tailEl.style.width = tailLen + 'px';
          }
          if (t < 1) requestAnimationFrame(animate);
          else {
            // fade out and remove
            clone.style.transition = 'opacity .35s linear';
            clone.style.opacity = '0';
            setTimeout(()=> { clone.remove(); }, 380);
          }
        }
        requestAnimationFrame(animate);
      }

      // spawn loop
      function loopSpawn(){
        const delay = 7000 + Math.random()*7000;
        setTimeout(()=> {
          if (!document.hidden) spawnOne();
          loopSpawn();
        }, delay);
      }
      loopSpawn();
    })();

    /* FIN del script (resto de l√≥gica de videos, chroma, etc. queda intacta) */
  </script>
</body>
</html>
