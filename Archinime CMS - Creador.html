<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archinime CMS: Master Console</title>
    <link rel="icon" href="Logo_Archinime.avif" type="image/avif">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root { 
            --bg-body: #050507;
            --bg-panel: #0f1014;
            --bg-input: #181920;
            --border: #2a2b35;
            --primary: #7c4dff; /* Violeta principal */
            --primary-hover: #9e75ff;
            --accent: #00e5ff; /* Cyan acento */
            --danger: #ff3366;
            --success: #00c853;
            --text-main: #ffffff;
            --text-muted: #8f90a6;
            --radius: 12px;
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
            --font-main: 'Outfit', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* --- LAYOUT PRINCIPAL --- */
        .cms-container {
            width: 100%;
            max-width: 1000px;
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 24px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            height: fit-content;
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: -0.5px;
            color: var(--text-main);
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .brand i { color: var(--primary); font-size: 1.4rem; }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 12px 16px;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-main);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-btn i { width: 20px; text-align: center; }
        
        .nav-btn:hover { background: rgba(255,255,255,0.03); color: var(--text-main); }
        .nav-btn.active { background: rgba(124, 77, 255, 0.15); color: var(--primary); border: 1px solid rgba(124, 77, 255, 0.3); }

        .user-status {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-input); object-fit: cover;}
        .logout-btn { margin-left: auto; color: var(--danger); cursor: pointer; background: none; border: none; font-size: 1rem; }

        /* --- MAIN CONTENT --- */
        .main-panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            min-height: 600px;
            position: relative;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 24px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* --- FORMS & INPUTS --- */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        
        .input-field {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 12px 16px;
            border-radius: 8px;
            font-family: var(--font-main);
            font-size: 0.95rem;
            transition: 0.2s;
        }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1); }
        textarea.input-field { min-height: 100px; resize: vertical; line-height: 1.6; }

        /* Grid inputs */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

        /* Dynamic Lists (Temporadas/Caps) */
        .dynamic-list { display: flex; flex-direction: column; gap: 12px; }
        .list-item { 
            background: rgba(255,255,255,0.02); 
            border: 1px solid var(--border); 
            padding: 16px; 
            border-radius: 8px; 
            position: relative;
        }
        .remove-btn {
            position: absolute; top: 10px; right: 10px;
            color: var(--text-muted); cursor: pointer;
            transition: 0.2s;
        }
        .remove-btn:hover { color: var(--danger); }

        .add-btn-dashed {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--border);
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .add-btn-dashed:hover { border-color: var(--primary); color: var(--primary); background: rgba(124, 77, 255, 0.05); }

        /* --- ACTION BUTTONS --- */
        .action-bar {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3);
        }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-primary:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; inset: 0;
            background: var(--bg-body);
            z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
        }
        .login-card {
            background: var(--bg-panel);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            max-width: 400px; width: 90%;
        }
        .github-btn {
            background: #24292e; color: white;
            width: 100%; padding: 14px;
            border-radius: 8px; border: none;
            font-weight: 600; font-size: 1rem;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 12px;
            margin-top: 20px; transition: 0.2s;
        }
        .github-btn:hover { background: #2f363d; transform: scale(1.02); }

        /* --- TOASTS --- */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--bg-panel); border: 1px solid var(--border);
            padding: 16px 24px; border-radius: 8px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: var(--shadow);
            transform: translateY(100px); opacity: 0;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }

        /* Responsive */
        @media (max-width: 768px) {
            .cms-container { grid-template-columns: 1fr; }
            .sidebar { position: static; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div style="font-size: 3rem; margin-bottom: 20px; color: var(--primary);"><i class="fas fa-cube"></i></div>
            <h1 style="margin:0 0 10px 0;">Archinime CMS</h1>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Consola de Administración Master</p>
            <button class="github-btn" onclick="handleGithubLogin()">
                <i class="fab fa-github"></i> Conectar con GitHub
            </button>
            <p id="login-status" style="margin-top: 15px; font-size: 0.85rem; color: var(--text-muted);"></p>
        </div>
    </div>

    <div class="cms-container hidden" id="app-interface">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-layer-group"></i> Archinime</div>
            
            <nav class="nav-menu">
                <button class="nav-btn active" onclick="switchTab('basic')">
                    <i class="fas fa-info-circle"></i> Datos Básicos
                </button>
                <button class="nav-btn" onclick="switchTab('seasons')">
                    <i class="fas fa-film"></i> Temp. y Capítulos
                </button>
                <button class="nav-btn" onclick="switchTab('player')">
                    <i class="fas fa-play-circle"></i> Reproductores
                </button>
                <button class="nav-btn" onclick="switchTab('music')">
                    <i class="fas fa-music"></i> Banda Sonora
                </button>
            </nav>

            <div class="user-status">
                <img id="user-img" class="user-avatar" src="" alt="User">
                <div style="flex:1; overflow:hidden;">
                    <div id="user-name" style="color:var(--text-main); font-weight:600; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">Usuario</div>
                    <div style="font-size:0.75rem; color:var(--success);">● Conectado</div>
                </div>
                <button class="logout-btn" onclick="handleLogout()"><i class="fas fa-power-off"></i></button>
            </div>
        </aside>

        <main class="main-panel">
            
            <div id="tab-basic" class="tab-content">
                <div class="section-title">Información del Anime</div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Título Principal</label>
                        <input type="text" id="title" class="input-field" placeholder="Ej: Dan Da Dan">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ID (Automático)</label>
                        <input type="text" id="anime-id" class="input-field" placeholder="Se genera al guardar..." readonly style="opacity: 0.7;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Sinopsis</label>
                    <textarea id="desc" class="input-field" placeholder="Descripción completa del anime..."></textarea>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Imagen de Portada (Archivo)</label>
                        <input type="text" id="cover" class="input-field" placeholder="Ej: dandadan.avif">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rating (0.0 - 5.0)</label>
                        <input type="number" id="rating" class="input-field" step="0.1" placeholder="4.9">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Géneros (Separados por coma)</label>
                    <input type="text" id="genres" class="input-field" placeholder="Acción, Comedia, Sobrenatural">
                </div>

                <div class="form-group">
                    <label class="form-label">Nombres Alternativos (Aliases)</label>
                    <input type="text" id="aliases" class="input-field" placeholder="Nombre en japonés, inglés...">
                </div>
            </div>

            <div id="tab-seasons" class="tab-content hidden">
                <div class="section-title">Temporadas y Episodios</div>
                <div id="seasons-list" class="dynamic-list"></div>
                <button class="add-btn-dashed" onclick="addSeasonUI()" style="margin-top:15px;">
                    <i class="fas fa-plus"></i> Añadir Temporada
                </button>
            </div>

            <div id="tab-player" class="tab-content hidden">
                <div class="section-title">Enlaces de Video (DB Player)</div>
                <div class="p-3 mb-4" style="background: rgba(0,200,83,0.1); border: 1px solid var(--success); border-radius:8px; font-size:0.9rem; color: #b9f6ca;">
                    <i class="fas fa-info-circle"></i> Los enlaces se vincularán automáticamente a las temporadas/capítulos creados en la pestaña anterior.
                </div>
                <div id="players-container" class="dynamic-list"></div>
            </div>

            <div id="tab-music" class="tab-content hidden">
                <div class="section-title">Música (OST/Openings)</div>
                <div id="music-list" class="dynamic-list"></div>
                <button class="add-btn-dashed" onclick="addMusicUI()" style="margin-top:15px;">
                    <i class="fas fa-music"></i> Añadir Pista de Audio
                </button>
            </div>

            <div class="action-bar">
                <button id="btn-publish" class="btn-primary" onclick="publishAll()">
                    <i class="fas fa-cloud-upload-alt"></i> PUBLICAR TODO EN GITHUB
                </button>
            </div>
        </main>
    </div>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-msg">Operación exitosa</span>
    </div>

<script>
// ============================================
// CONFIGURACIÓN
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyBpzYARIxaJijLbbL-2S6F9MWecbAbvK_I",
    authDomain: "login-admin-archinime.firebaseapp.com",
    projectId: "login-admin-archinime",
    storageBucket: "login-admin-archinime.firebasestorage.app",
    messagingSenderId: "938164660242",
    appId: "1:938164660242:web:648e0dce0e0d18dd78d0cb"
};

const ALLOWED_USERS = ["archinime12@gmail.com"];

firebase.initializeApp(firebaseConfig);

    // --- STATE MANAGEMENT ---
    let currentUserToken = null;
    let currentAnimeId = null; // Se calculará al leer index-data.js
    let seasonsData = []; // Estructura temporal para UI

    // --- AUTH LOGIC ---
    function initApp() {
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-interface').classList.remove('hidden');
                
                document.getElementById('user-name').innerText = user.displayName || "Admin";
                document.getElementById('user-img').src = user.photoURL || "https://ui-avatars.com/api/?name=Admin";

                // INTENTO RECUPERAR TOKEN SI SE PERDIÓ
                if (!currentUserToken) {
                    console.warn("⚠️ Token OAuth perdido por recarga. Usando TOKEN MANUAL DE RESPALDO.");
                    currentUserToken = BACKUP_TOKEN; // <--- AQUÍ ESTÁ LA MAGIA
                }
                
                log("Sistema listo. Token activo.");
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-interface').classList.add('hidden');
            }
        });
    }

    function handleGithubLogin() {
        const provider = new firebase.auth.GithubAuthProvider();
        provider.addScope('repo'); // Permiso de escritura
        
        document.getElementById('login-status').innerText = "Conectando con GitHub...";

        firebase.auth().signInWithPopup(provider)
            .then((result) => {
                // El token "fresco" viene aquí
                currentUserToken = result.credential.accessToken;
                console.log("Token OAuth obtenido exitosamente.");
            }).catch((error) => {
                console.error(error);
                // Si falla el popup, intentamos usar el manual si el usuario ya está logueado en firebase
                if(firebase.auth().currentUser) {
                     currentUserToken = BACKUP_TOKEN;
                     log("Error en popup, pero usando token manual.");
                     document.getElementById('login-screen').classList.add('hidden');
                     document.getElementById('app-interface').classList.remove('hidden');
                } else {
                    document.getElementById('login-status').innerText = "Error: " + error.message;
                }
            });
    }

    function handleLogout() {
        firebase.auth().signOut().then(() => window.location.reload());
    }

    // --- UI TABS ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        event.currentTarget.classList.add('active');

        // Si cambiamos a player, refrescar la vista basada en temporadas
        if(tabId === 'player') renderPlayerFields();
    }

    // --- SEASONS UI LOGIC ---
    function addSeasonUI() {
        const seasonIndex = seasonsData.length + 1;
        const seasonObj = { num: seasonIndex, cover: '', eps: [] };
        seasonsData.push(seasonObj);
        renderSeasons();
    }

    function addEpisodeUI(seasonIdx) {
        seasonsData[seasonIdx].eps.push({ title: `Capítulo ${seasonsData[seasonIdx].eps.length + 1}` });
        renderSeasons();
    }

    function removeSeason(idx) {
        seasonsData.splice(idx, 1);
        // Renumerar
        seasonsData.forEach((s, i) => s.num = i + 1);
        renderSeasons();
    }

    function renderSeasons() {
        const container = document.getElementById('seasons-list');
        container.innerHTML = "";

        seasonsData.forEach((season, sIdx) => {
            const el = document.createElement('div');
            el.className = 'list-item';
            el.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong><i class="fas fa-tv"></i> Temporada ${season.num}</strong>
                    <i class="fas fa-trash remove-btn" onclick="removeSeason(${sIdx})"></i>
                </div>
                <div class="grid-2" style="margin-bottom:10px;">
                    <input type="text" class="input-field" placeholder="Cover Temp (Ej: dan1.jpg)" 
                        value="${season.cover}" oninput="seasonsData[${sIdx}].cover = this.value">
                </div>
                
                <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                    <small style="color:var(--text-muted); display:block; margin-bottom:8px;">Episodios: ${season.eps.length}</small>
                    <div id="eps-list-${sIdx}" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:8px;">
                        ${season.eps.map((ep, eIdx) => `
                            <input type="text" class="input-field" style="padding:8px; font-size:0.85rem;" 
                            value="${ep.title}" oninput="seasonsData[${sIdx}].eps[${eIdx}].title = this.value">
                        `).join('')}
                    </div>
                    <button class="add-btn-dashed" style="margin-top:10px; padding:8px; font-size:0.85rem;" onclick="addEpisodeUI(${sIdx})">
                        + Añadir Cap
                    </button>
                </div>
            `;
            container.appendChild(el);
        });
    }

    // --- PLAYER UI LOGIC ---
    // Genera campos de link basados en las temporadas creadas
    function renderPlayerFields() {
        const container = document.getElementById('players-container');
        container.innerHTML = "";
        
        if(seasonsData.length === 0) {
            container.innerHTML = "<div style='color:var(--text-muted); text-align:center; padding:20px;'>Añade temporadas primero</div>";
            return;
        }

        seasonsData.forEach((season, sIdx) => {
            if(!season.links) season.links = {}; // Inicializar si no existe

            let html = `<div class="list-item">
                <div style="font-weight:700; margin-bottom:12px; color:var(--accent);">Temporada ${season.num}</div>`;
            
            season.eps.forEach((ep, eIdx) => {
                const epNum = eIdx + 1;
                // Init link structure for this ep
                if(!season.links[epNum]) season.links[epNum] = { link: '', link2: '' };

                html += `
                <div style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                    <label class="form-label" style="font-size:0.8rem;">Capítulo ${epNum}</label>
                    <div class="grid-2">
                        <input type="text" class="input-field" placeholder="Google Drive Link" 
                            value="${season.links[epNum].link}" 
                            onchange="updateLink(${sIdx}, ${epNum}, 'link', this.value)">
                        <input type="text" class="input-field" placeholder="Dropbox/Opción 2" 
                            value="${season.links[epNum].link2 || ''}" 
                            onchange="updateLink(${sIdx}, ${epNum}, 'link2', this.value)">
                    </div>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    function updateLink(sIdx, epNum, type, val) {
        if(!seasonsData[sIdx].links) seasonsData[sIdx].links = {};
        if(!seasonsData[sIdx].links[epNum]) seasonsData[sIdx].links[epNum] = {};
        seasonsData[sIdx].links[epNum][type] = val;
    }

    // --- MUSIC UI LOGIC ---
    let musicList = [];
    function addMusicUI() {
        musicList.push("");
        renderMusic();
    }
    
    function renderMusic() {
        const container = document.getElementById('music-list');
        container.innerHTML = "";
        musicList.forEach((track, idx) => {
            const el = document.createElement('div');
            el.className = 'grid-2';
            el.style.marginBottom = "10px";
            el.innerHTML = `
                <input type="text" class="input-field" placeholder="Nombre archivo .mp3" value="${track}" oninput="musicList[${idx}] = this.value">
                <button onclick="musicList.splice(${idx},1); renderMusic()" style="background:var(--bg-input); border:1px solid var(--border); color:var(--danger); border-radius:8px; cursor:pointer;"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(el);
        });
    }

    // --- CORE: GITHUB SYNC LOGIC ---

    const OWNER = "Archinime";
    const REPO = "-Archinime-";

    async function publishAll() {
        const btn = document.getElementById('btn-publish');
        
        // CHECK TOKEN MANUAL
        if (!currentUserToken) currentUserToken = BACKUP_TOKEN;

        if(!currentUserToken) return alert("FATAL: No hay token disponible.");

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Procesando...';

            // 1. LEER index-data.js para calcular nuevo ID
            log("Leyendo índice para obtener ID...");
            const indexFile = await getGithubFile(currentUserToken, OWNER, REPO, "index-data.js");
            
            // Extraer el array actual usando regex sucio pero efectivo para no usar eval
            let indexContent = indexFile.content;
            // Parseamos "manualmente" buscando el último ID
            const idRegex = /id:(\d+)/g;
            let match;
            let maxId = 0;
            while ((match = idRegex.exec(indexContent)) !== null) {
                const id = parseInt(match[1]);
                if (id > maxId) maxId = id;
            }
            const NEW_ID = maxId + 1;
            document.getElementById('anime-id').value = NEW_ID;
            log(`Nuevo ID generado: ${NEW_ID}`);

            // 2. PREPARAR DATOS
            // A. Index Data Item
            const newIndexItem = {
                id: NEW_ID,
                title: document.getElementById('title').value,
                aliases: document.getElementById('aliases').value.split(',').map(s=>s.trim()).filter(s=>s),
                img: document.getElementById('cover').value,
                rating: parseFloat(document.getElementById('rating').value) || 0,
                genres: document.getElementById('genres').value.split(',').map(s=>s.trim()).filter(s=>s)
            };

            // B. Anime Detail Data
            const newDetailData = {
                title: newIndexItem.title,
                desc: document.getElementById('desc').value,
                cover: newIndexItem.img,
                seasons: seasonsData.map(s => ({
                    num: s.num,
                    cover: s.cover,
                    eps: s.eps // ya tiene {title}
                }))
            };

            // C. Player Data
            const newPlayerData = {}; // Estructura: { "1": { "1": { link... } } }
            seasonsData.forEach(s => {
                const sNumStr = s.num.toString();
                newPlayerData[sNumStr] = {};
                if(s.links) {
                    Object.keys(s.links).forEach(epKey => {
                        newPlayerData[sNumStr][epKey] = {
                            link: s.links[epKey].link,
                            link2: s.links[epKey].link2,
                            title: `${newIndexItem.title} T${s.num} Cap ${epKey}`
                        };
                    });
                }
            });

            // D. Music Data
            const newMusicData = musicList.filter(m => m.trim() !== "");

            // 3. ACTUALIZAR ARCHIVOS EN ORDEN

            // -> Update index-data.js
            await updateGithubFile(currentUserToken, OWNER, REPO, "index-data.js", content => {
                // Insertar antes del cierre de array '];'
                const insertStr = `,\n      ${JSON.stringify(newIndexItem)}`;
                return content.replace(/\s*\];/, insertStr + "\n];");
            });
            log("Index actualizado.");

            // -> Update anime-detail-data.js
            await updateGithubFile(currentUserToken, OWNER, REPO, "anime-detail-data.js", content => {
                // Insertar nueva key antes de la llave de cierre final
                // Formato: const data = { ... , NEW_ID: {OBJ} };
                // Buscamos la última llave de cierre
                const newItemStr = `,\n    ${NEW_ID}: ${JSON.stringify(newDetailData, null, 4)}`;
                return content.replace(/\s*};(\s*)$/, newItemStr + "\n};");
            });
            log("Detalles actualizados.");

            // -> Update video-player-data.js
            await updateGithubFile(currentUserToken, OWNER, REPO, "video-player-data.js", content => {
                const newItemStr = `,\n      "${NEW_ID}": ${JSON.stringify(newPlayerData, null, 4)}`;
                return content.replace(/\s*};(\s*)$/, newItemStr + "\n};");
            });
            log("Player actualizado.");

            // -> Update musica-data.js
            if (newMusicData.length > 0) {
                await updateGithubFile(currentUserToken, OWNER, REPO, "musica-data.js", content => {
                     const newItemStr = `,\n        ${NEW_ID}: ${JSON.stringify(newMusicData, null, 4)}`;
                     return content.replace(/\s*};(\s*)$/, newItemStr + "\n};");
                });
                log("Música actualizada.");
            }

            log("✅ TODO TERMINADO CON ÉXITO");
            showToast("Anime subido correctamente con ID: " + NEW_ID, "success");
            btn.innerHTML = '<i class="fas fa-check"></i> Publicado';
            alert(`¡Anime subido correctamente con ID: ${NEW_ID}`);
        } catch (e) {
            log("❌ ERROR CRÍTICO: " + e.message);
            console.error(e);
            alert("Error: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }

    // GitHub Utils
    async function getGithubFile(token, owner, repo, path) {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const res = await fetch(url, { headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" } });
        if(!res.ok) throw new Error(`Error leyendo ${path} (${res.status})`);
        const data = await res.json();
        // Decode base64 UTF8
        const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
        return { sha: data.sha, content: content };
    }

    async function updateGithubFile(token, owner, repo, path, modifyCallback) {
        const current = await getGithubFile(token, owner, repo, path);
        const newContent = modifyCallback(current.content);
        
        // Encode base64 UTF8
        const encoded = btoa(new TextEncoder().encode(newContent).reduce((data, byte) => data + String.fromCharCode(byte), ''));
        
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const res = await fetch(url, {
            method: "PUT",
            headers: { 
                "Authorization": `token ${token}`, 
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `CMS Update: ${path}`,
                content: encoded,
                sha: current.sha
            })
        });
        if(!res.ok) throw new Error(`Error escribiendo ${path}`);
    }

    function log(msg) {
        console.log(`[CMS] ${msg}`);
        document.getElementById('toast-msg').innerText = msg;
    }

    function showToast(msg, type="success") {
        const t = document.getElementById('toast');
        t.className = `toast show ${type}`;
        t.querySelector('span').innerText = msg;
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Start
    initApp();

</script>
</body>
</html>