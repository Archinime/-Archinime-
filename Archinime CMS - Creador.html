<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archinime CMS: Master Console</title>
    <link rel="icon" href="Logo_Archinime.avif" type="image/avif">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <link rel="stylesheet" href="styles.css">

    <style>
        /* ESTILOS EXTRA PARA EL MODAL DE PERFIL */
        #profileSetupModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; display: none;
            flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .profile-card {
            background: #131419; border: 1px solid #333; border-radius: 20px;
            padding: 30px; max-width: 450px; width: 100%;
            box-shadow: 0 0 50px rgba(0, 240, 255, 0.1); text-align: center;
        }
        .profile-card h2 { border: none; justify-content: center; color: #fff; font-size: 1.5rem; margin-bottom: 10px; }
        .profile-card p { color: #888; font-size: 0.9rem; margin-bottom: 25px; }
        .p-input-group { text-align: left; margin-bottom: 15px; }
        .p-input-group label { margin-top: 0; margin-bottom: 5px; }
        .profile-preview-img {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 2px solid #00f0ff; margin: 0 auto 20px; display: block; background: #000;
        }

        /* ESTILOS NUEVOS PARA LA VALORACI√ìN DIVIDIDA */
        .rating-container {
            display: flex; align-items: flex-end; gap: 10px;
        }
        .rating-box {
            width: 60px; text-align: center; font-size: 1.5rem; font-weight: 800;
            padding: 10px 5px; background: #181920; border: 2px solid #2a2b35;
            border-radius: 12px; color: #fff; appearance: none;
        }
        .rating-box:focus { border-color: #facc15; outline: none; }
        .rating-dot { font-size: 2rem; font-weight: 800; color: #fff; padding-bottom: 10px; }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <img src="Logo_Archinime.avif" alt="Archinime Logo" class="login-logo">
        <h1 style="color:#fff; margin:0; font-size:1.8rem; font-weight:800;">ARCHINIME CMS</h1>
        <p style="color:var(--text-muted); margin-top:8px; font-size:0.9rem;">Consola de Aportadores</p>
        
        <button class="login-btn" onclick="signInWithGitHub()">
            <i class="fab fa-github" style="font-size:1.5em"></i> Conectar con GitHub
        </button>
        
        <div id="loginError" style="color: #ff4757; margin-top: 20px; display: none; background: rgba(255, 71, 87, 0.1); padding: 10px; border-radius: 8px; font-size: 0.9em;">
            <i class="fas fa-ban"></i> <span id="errorText">Acceso Denegado</span>
        </div>
    </div>
</div>

<div id="profileSetupModal">
    <div class="profile-card">
        <img id="setupAvatarPreview" src="Logo_Archinime.avif" class="profile-preview-img">
        <h2 id="modalTitle">Bienvenido/a</h2>
        <p id="modalDesc">Es tu primera vez aqu√≠. Configura tu cuenta para continuar.</p>

        <div class="p-input-group">
            <label>Elige tu Nombre de Usuario <span>*</span></label>
            <input type="text" id="setupNick" placeholder="Ej: Usuario">
        </div>

        <div class="p-input-group">
            <label>Avatar por defecto de GitHub <span>*</span></label>
            <input type="text" id="setupAvatar" placeholder="URL de imagen..." oninput="updateProfilePreview(this)">
        </div>

        <div class="p-input-group">
            <label>Link Red Social (Opcional)</label>
            <input type="text" id="setupSocial" placeholder="Youtube, Instagram...">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 40px;">
            <button class="btn btn-gen" id="btnSaveProfile" onclick="saveUserProfile()" style="margin-top: 0; flex: 1;">
                 GUARDAR PERFIL
            </button>
            <button class="btn" id="btnCancelProfile" onclick="closeProfileModal()" style="margin-top: 0; background: transparent; border: 1px solid #333; color: #aaa; width: auto; display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="profileLog" style="margin-top:10px; color:#00f0ff; font-size:0.8em;"></div>
    </div>
</div>

<div id="userHeader" class="user-header">
    <div class="header-profile" onclick="openProfileEditor()" style="cursor: pointer;" title="Clic para editar perfil">
        <img id="userAvatarImg" src="" style="width:36px; height:36px; border-radius:50%; border:2px solid var(--primary);">
        <div>
            <div class="user-badge">Verificado</div>
            <div id="userNameDisplay" class="user-name">Usuario</div>
        </div>
        <i class="fas fa-pen" style="font-size:0.7em; color:#555; margin-left:5px;"></i>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="openSearchModal()" style="background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.8em;">
            <i class="fas fa-folder-open"></i> CARGAR / EDITAR
        </button>
        <button onclick="logout()" style="background:transparent; color:#fff; border:1px solid #333; padding:8px 12px; border-radius:8px; cursor:pointer;">
            <i class="fas fa-power-off"></i>
        </button>
    </div>
</div>

<div id="searchModal" onclick="handleModalClick(event)">
    <div class="search-box">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; color:#fff;">üìÇ Cargar Anime</h3>
            <button onclick="closeSearchModal()" style="background:none; border:none; color:#ff4757; font-size:1.2em; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="search-tabs">
            <button class="tab-btn active" id="tabMine" onclick="switchSearchTab('mine')">
                <i class="fas fa-user-tag"></i> Mis Animes
            </button>
            <button class="tab-btn" id="tabGeneral" onclick="switchSearchTab('general')">
                 <i class="fas fa-globe"></i> General
            </button>
        </div>

        <div style="padding:10px;">
            <input type="text" id="searchInput" placeholder="Buscar por nombre..." style="margin:0;" oninput="filterSearch()">
            <div id="loadingSearch" style="color:var(--accent); text-align:center; padding:10px; display:none;">Cargando √≠ndice...</div>
        </div>
        <div id="searchResults" class="search-results"></div>
    </div>
</div>

<div class="main-wrapper" id="cmsContent">
    
    <div class="editor-panel">
        
        <div id="editModeBar">
            <i class="fas fa-edit"></i> MODO EDICI√ìN ACTIVADO (ID: <span id="editIdDisplay">0</span>)
            <div style="font-size:0.8em; font-weight:normal; margin-top:5px;">Los cambios sobrescribir√°n el anime existente.</div>
            <button onclick="exitEditMode()" style="background:rgba(0,0,0,0.3); border:1px solid #fff; color:#fff; padding:4px 10px; border-radius:4px; margin-top:5px; cursor:pointer;">Cancelar Edici√≥n</button>
        </div>

        <h2><i class="fas fa-pen-to-square"></i> 1. Ficha T√©cnica</h2>
        
        <label>T√≠tulo Principal <span>*</span></label>
        <input type="text" id="tituloAnime" placeholder="Ej: Dragon Ball Z" onblur="autoCap(this); validate(this);" oninput="requestPreviewUpdate()">

        <label>Alias Alternativos</label>
        <div id="aliasContainer"></div>
        <button class="btn btn-add" style="margin-top:10px; padding:12px;" onclick="addAlias()">
            <i class="fas fa-plus"></i> AGREGAR ALIAS
        </button>

        <label style="margin-top:25px">URL Portada Vertical (.AVIF) <span>*</span></label>
        <div style="margin-bottom:5px; font-size:0.8em; color:var(--accent);">
            Permitido: 1000x1500, 1400x2100, 2000x3000, 2090x3135, 3412x5120
        </div>
        <div style="display:flex; gap:15px; align-items: flex-start; flex-wrap: wrap;">
            <div style="flex:1; min-width: 200px;">
                <input type="text" id="portadaAnime" placeholder="https://..." oninput="checkCoverVisual(this); requestPreviewUpdate()" onblur="validate(this); smartLinkConvert(this)">
                <div id="dimDisplay" style="color:var(--text-muted); font-size:0.8em; margin-top:8px; font-family:'JetBrains Mono'"></div>
            </div>
            <img id="mainCoverPreview" style="width:100px; height:140px; border-radius:10px; background:#111; object-fit:cover; display:none; border:1px solid var(--accent)">
        </div>
        
        <label>G√©neros (Selecciona varios) <span>*</span></label>
        <div class="genres-box" id="genresContainer"></div>

        <label>Sinopsis <span>*</span></label>
        <textarea id="sinopsisAnime" rows="5" placeholder="Sinopsis oficial..." onblur="autoCap(this); validate(this)" oninput="requestPreviewUpdate()"></textarea>
        
        <div class="row-flex">
            <div class="col-flex">
                <label>Demograf√≠a <span>*</span></label>
                <select id="demografiaAnime" onchange="requestPreviewUpdate()">
                    <option value="" disabled selected>Elegir Demograf√≠a...</option>
                    <option value="Sh≈çnen">Sh≈çnen</option>
                    <option value="Seinen">Seinen</option>
                    <option value="Sh≈çjo">Sh≈çjo</option>
                    <option value="Josei">Josei</option>
                    <option value="Kodomo">Kodomo</option>
                    <option value="Seijin">Seijin</option>
                </select>
            </div>
            <div class="col-flex">
                <label>Valoraci√≥n (Ej: 4.5) <span>*</span></label>
                <div class="rating-container">
                    <input type="number" id="ratingInt" class="rating-box" min="1" max="5" placeholder="4" oninput="limitRating(this, 1, 5); requestPreviewUpdate()">
                    <span class="rating-dot">.</span>
                    <input type="number" id="ratingDec" class="rating-box" min="0" max="9" placeholder="5" oninput="limitRating(this, 0, 9); requestPreviewUpdate()">
                </div>
            </div>
        </div>

        <h2 style="margin-top:50px"><i class="fas fa-layer-group"></i> 2. Estructura</h2>
        <div id="seasonsContainer"></div>
        <button class="btn btn-add" onclick="addSeason()"><i class="fas fa-folder-plus"></i> NUEVA TEMPORADA / PEL√çCULA</button>

        <h2 style="margin-top:50px"><i class="fas fa-music"></i> 3. Banda Sonora</h2>
        <div id="musicContainer"></div>
        <button class="btn btn-add" style="border-color:var(--primary); color:var(--primary)" onclick="addMusic()"><i class="fas fa-music"></i> AGREGAR AUDIO</button>

        <button class="btn btn-gen" id="btnSaveAction" onclick="subirAGithHub()">
            <i class="fas fa-cloud-arrow-up"></i> <span id="btnActionText">COMPILAR Y SUBIR</span>
        </button>
        
        <div id="statusLog"></div>
    </div>

    <div class="preview-sidebar">
        <h3 style="color:var(--text-muted); font-size:0.8em; margin-bottom:15px; letter-spacing:2px; text-transform:uppercase; font-weight:700;">Vista Previa App</h3>
        <div class="web-card">
            <img id="webCover" class="web-cover" src="https://via.placeholder.com/400x600/111/333?text=Cover">
            <div class="web-info">
                <div id="webTitle" class="web-title">T√≠tulo</div>
                <div id="webAlias" class="web-alias">
                    <div>ID: <span id="previewId">###</span></div>
                    <div id="previewAliasesList" style="margin-top:4px; font-style: italic; color:#777;"></div>
                </div>
                
                <div style="display:flex; justify-content:space-between; margin-top:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                    <span id="webDemography" style="color:var(--accent); font-weight:700; font-size:0.8em">DEMO</span>
                    <span id="webRating" style="color:#facc15; font-size:0.8em">‚≠ê --</span>
                </div>
                <div id="webTags" style="display:flex; flex-wrap:wrap; gap:6px; margin:15px 0;"></div>
                
                <div style="font-size:0.7em; font-weight:bold; color:#777; margin-top:20px; letter-spacing:1px;">COLECCI√ìN:</div>
                <div id="webSeasonsGrid" class="preview-seasons-grid"></div>
            </div>
        </div>
    </div>
</div>

<div id="toast"><i class="fas fa-check-circle"></i> <span>Notificaci√≥n</span></div>

<script src="script.js"></script>

</body>
</html>